<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#FF5252">
  <meta http-equiv="Content-Language" content="es">
  <meta name="language" content="Spanish">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Recetas Chef Per√∫</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="./print.css" media="print">
  <style>
    /* Estilos para la secci√≥n de impresi√≥n */
    .print-controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    #print-content-wrapper {
      border: 1px solid #e0e0e0;
      padding: 24px;
      background-color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      overflow-x: auto;
    }
    @media (max-width: 900px) {
      #print-content-wrapper {
        max-width: 100vw;
        padding: 8px;
      }
      #print-content {
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
      }
    }
    #print-content h1 {
      color: var(--primary-color);
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
    }
    #print-content h2 {
      color: var(--primary-color);
      font-size: 22px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 8px;
      margin-top: 24px;
      margin-bottom: 16px;
    }
    #print-content .meta-info {
      text-align: center;
      font-style: italic;
      color: #666;
      margin-bottom: 24px;
    }
    #print-content ul, #print-content ol {
      padding-left: 20px;
    }
    #print-content li {
      margin-bottom: 8px;
    }
    #print-content .photo-section {
      margin-top: 24px;
    }
    #print-content .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    #print-content .photo-item img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #print-content .photo-item p {
      font-size: 14px;
      color: #333;
      margin-top: 8px;
    }
    #print-content .logbook-entry {
      border-left: 4px solid var(--accent-color);
      padding-left: 16px;
      margin-bottom: 16px;
      background-color: #f9f9f9;
      padding: 12px;
      border-radius: 4px;
    }
  </style>
  <!-- Remover Chart.js que est√° causando problemas -->
  <script>
    // Funci√≥n simple para generar gr√°fico SVG sin dependencias externas
    function generarGraficoSVG(costosFijos, costoVariableUnitario, precioVenta, unidadesEquilibrio, enPerdida = false) {
      const container = document.getElementById('breakeven-chart-container');
      if (!container) {
        console.error('Contenedor breakeven-chart-container no encontrado');
        return false;
      }
      
      // Ajustar la escala seg√∫n el escenario
      let maxUnits, maxMoney, titulo, subtitulo;
      
      if (enPerdida) {
        // En p√©rdida: mostrar un rango que permita ver claramente el problema
        maxUnits = Math.max(20, costosFijos / Math.abs(precioVenta - costoVariableUnitario) * 2);
        maxMoney = Math.max(costosFijos * 1.5, maxUnits * Math.max(precioVenta, costoVariableUnitario) * 1.2);
        titulo = '‚ö†Ô∏è AN√ÅLISIS DE P√âRDIDA - No hay punto de equilibrio';
        subtitulo = `P√©rdida de S/${(costoVariableUnitario - precioVenta).toFixed(2)} por cada unidad vendida`;
      } else {
        maxUnits = Math.max(10, unidadesEquilibrio * 2);
        maxMoney = Math.max(costosFijos * 2, unidadesEquilibrio * precioVenta * 1.2);
        titulo = `‚úÖ Punto de Equilibrio: ${unidadesEquilibrio} unidades`;
        subtitulo = `Ingresos necesarios: S/${(unidadesEquilibrio * precioVenta).toFixed(2)}`;
      }
      
      const width = 600;
      const height = 450; // Aumentamos la altura para m√°s informaci√≥n
      const margin = { top: 60, right: 20, bottom: 80, left: 80 }; // M√°s espacio para t√≠tulos
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;
      
      let svg = `
        <svg width="${width}" height="${height}" style="background: white; border: 1px solid #ddd; border-radius: 8px;">
          <!-- T√≠tulo principal -->
          <text x="${width/2}" y="25" text-anchor="middle" style="font-size: 16px; font-weight: bold; fill: ${enPerdida ? '#f44336' : '#4caf50'};">
            ${titulo}
          </text>
          <!-- Subt√≠tulo -->
          <text x="${width/2}" y="45" text-anchor="middle" style="font-size: 12px; fill: #666;">
            ${subtitulo}
          </text>
          
          <!-- Ejes -->
          <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${height - margin.bottom}" stroke="#333" stroke-width="2"/>
          <line x1="${margin.left}" y1="${height - margin.bottom}" x2="${width - margin.right}" y2="${height - margin.bottom}" stroke="#333" stroke-width="2"/>
          
          <!-- Etiquetas de ejes -->
          <text x="${margin.left + chartWidth/2}" y="${height - 20}" text-anchor="middle" style="font-size: 12px; fill: #666;">Unidades Producidas</text>
          <text x="25" y="${margin.top + chartHeight/2}" text-anchor="middle" transform="rotate(-90, 25, ${margin.top + chartHeight/2})" style="font-size: 12px; fill: #666;">Monto (S/)</text>
      `;
      
      // Calcular puntos para las l√≠neas
      const points = [];
      const stepSize = Math.max(1, Math.floor(maxUnits/20));
      for (let i = 0; i <= maxUnits; i += stepSize) {
        const x = margin.left + (i / maxUnits) * chartWidth;
        const costoTotal = costosFijos + (i * costoVariableUnitario);
        const ingresos = i * precioVenta;
        
        const yCostoTotal = height - margin.bottom - (costoTotal / maxMoney) * chartHeight;
        const yIngresos = height - margin.bottom - (ingresos / maxMoney) * chartHeight;
        const yCostosFijos = height - margin.bottom - (costosFijos / maxMoney) * chartHeight;
        
        points.push({ x, yCostoTotal, yIngresos, yCostosFijos, units: i, costoTotal, ingresos });
      }
      
      // √Årea de p√©rdida/ganancia
      if (enPerdida) {
        // Toda el √°rea es de p√©rdida - colorear de rojo claro
        svg += `<rect x="${margin.left}" y="${margin.top}" width="${chartWidth}" height="${chartHeight}" fill="rgba(244, 67, 54, 0.1)" stroke="none"/>`;
        svg += `<text x="${margin.left + chartWidth/2}" y="${margin.top + 20}" text-anchor="middle" style="font-size: 14px; font-weight: bold; fill: #f44336;">ZONA DE P√âRDIDA</text>`;
      } else {
        // √Årea de p√©rdida (antes del punto de equilibrio)
        const xEquilibrio = margin.left + (unidadesEquilibrio / maxUnits) * chartWidth;
        svg += `<rect x="${margin.left}" y="${margin.top}" width="${xEquilibrio - margin.left}" height="${chartHeight}" fill="rgba(244, 67, 54, 0.1)" stroke="none"/>`;
        svg += `<rect x="${xEquilibrio}" y="${margin.top}" width="${width - margin.right - xEquilibrio}" height="${chartHeight}" fill="rgba(76, 175, 80, 0.1)" stroke="none"/>`;
        
        // Etiquetas de zonas
        if (xEquilibrio > margin.left + 60) {
          svg += `<text x="${margin.left + (xEquilibrio - margin.left)/2}" y="${margin.top + 20}" text-anchor="middle" style="font-size: 12px; font-weight: bold; fill: #f44336;">P√âRDIDA</text>`;
        }
        if (width - margin.right - xEquilibrio > 60) {
          svg += `<text x="${xEquilibrio + (width - margin.right - xEquilibrio)/2}" y="${margin.top + 20}" text-anchor="middle" style="font-size: 12px; font-weight: bold; fill: #4caf50;">GANANCIA</text>`;
        }
      }
      
      // L√≠nea de costos fijos
      svg += `<line x1="${margin.left}" y1="${points[0].yCostosFijos}" x2="${width - margin.right}" y2="${points[0].yCostosFijos}" stroke="#FF9800" stroke-width="3" stroke-dasharray="8,4"/>`;
      
      // L√≠neas de costos totales e ingresos
      let costosPath = `M ${points[0].x} ${points[0].yCostoTotal}`;
      let ingresosPath = `M ${points[0].x} ${points[0].yIngresos}`;
      
      for (let i = 1; i < points.length; i++) {
        costosPath += ` L ${points[i].x} ${points[i].yCostoTotal}`;
        ingresosPath += ` L ${points[i].x} ${points[i].yIngresos}`;
      }
      
      svg += `<path d="${costosPath}" stroke="#f44336" stroke-width="3" fill="none"/>`;
      svg += `<path d="${ingresosPath}" stroke="${enPerdida ? '#ff9800' : '#4caf50'}" stroke-width="3" fill="none"/>`;
      
      // Punto de equilibrio (solo si no hay p√©rdida)
      if (!enPerdida && unidadesEquilibrio > 0) {
        const xEquilibrio = margin.left + (unidadesEquilibrio / maxUnits) * chartWidth;
        const yEquilibrio = height - margin.bottom - ((unidadesEquilibrio * precioVenta) / maxMoney) * chartHeight;
        svg += `<circle cx="${xEquilibrio}" cy="${yEquilibrio}" r="6" fill="#1976d2" stroke="white" stroke-width="3"/>`;
        svg += `<text x="${xEquilibrio}" y="${yEquilibrio - 15}" text-anchor="middle" style="font-size: 11px; font-weight: bold; fill: #1976d2;">PE</text>`;
      }
      
      // Escalas en los ejes
      for (let i = 0; i <= 5; i++) {
        const yPos = height - margin.bottom - (i / 5) * chartHeight;
        const value = (i / 5) * maxMoney;
        svg += `<line x1="${margin.left - 5}" y1="${yPos}" x2="${margin.left}" y2="${yPos}" stroke="#666" stroke-width="1"/>`;
        svg += `<text x="${margin.left - 10}" y="${yPos + 3}" text-anchor="end" style="font-size: 10px; fill: #666;">S/${value.toFixed(0)}</text>`;
      }
      
      for (let i = 0; i <= 5; i++) {
        const xPos = margin.left + (i / 5) * chartWidth;
        const value = (i / 5) * maxUnits;
        svg += `<line x1="${xPos}" y1="${height - margin.bottom}" x2="${xPos}" y2="${height - margin.bottom + 5}" stroke="#666" stroke-width="1"/>`;
        svg += `<text x="${xPos}" y="${height - margin.bottom + 18}" text-anchor="middle" style="font-size: 10px; fill: #666;">${value.toFixed(0)}</text>`;
      }
      
      // Leyenda mejorada
      svg += `
        <g transform="translate(${width - 220}, 70)">
          <rect x="0" y="0" width="200" height="${enPerdida ? '60' : '80'}" fill="white" stroke="#ddd" stroke-width="1" rx="4"/>
          <line x1="10" y1="15" x2="30" y2="15" stroke="#FF9800" stroke-width="3" stroke-dasharray="8,4"/>
          <text x="35" y="19" style="font-size: 11px; fill: #333;">Costos Fijos (S/${costosFijos.toFixed(0)})</text>
          <line x1="10" y1="30" x2="30" y2="30" stroke="#f44336" stroke-width="3"/>
          <text x="35" y="34" style="font-size: 11px; fill: #333;">Costos Totales</text>
          <line x1="10" y1="45" x2="30" y2="45" stroke="${enPerdida ? '#ff9800' : '#4caf50'}" stroke-width="3"/>
          <text x="35" y="49" style="font-size: 11px; fill: #333;">Ingresos (S/${precioVenta.toFixed(2)}/u)</text>
      `;
      
      if (!enPerdida) {
        svg += `<circle cx="20" cy="60" r="4" fill="#1976d2" stroke="white" stroke-width="2"/>
          <text x="35" y="64" style="font-size: 11px; fill: #333;">Punto Equilibrio</text>`;
      }
      
      svg += '</g>';
      
      // Mensaje educativo adicional
      if (enPerdida) {
        svg += `
          <g transform="translate(${margin.left}, ${height - 40})">
            <text x="0" y="0" style="font-size: 12px; font-weight: bold; fill: #f44336;">üí° Para salir de p√©rdida, necesitas:</text>
            <text x="0" y="15" style="font-size: 11px; fill: #666;">‚Ä¢ Subir precio a m√≠nimo S/${(costoVariableUnitario + 0.01).toFixed(2)} o ‚Ä¢ Reducir costos variables</text>
          </g>
        `;
      }
      
      svg += '</svg>';
      
      container.innerHTML = svg;
      return true;
    }
    
    // Hacer disponible globalmente
    window.generarGraficoPuntoEquilibrio = generarGraficoSVG;
  </script>
  <script>
    // Forzar idioma espa√±ol
    if (document.documentElement.lang !== 'es') {
      document.documentElement.lang = 'es';
    }
    
    // Hacer que la aplicaci√≥n sea m√°s robusta frente a diferentes tipos de recarga
    window.addEventListener('DOMContentLoaded', function() {
      console.log('DOM completamente cargado y parseado');
      // Asegurar que el idioma es espa√±ol
      document.documentElement.lang = 'es';
    });
  </script>
  <style>
    /* Correcci√≥n para textos en ingl√©s */
    .nav-tab[data-tab="ingredients"] .material-icons::after {
      content: "Ingredientes";
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
    .nav-tab[data-tab="preparation"] .material-icons::after {
      content: "Preparaci√≥n";
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
    .nav-tab[data-tab="photos"] .material-icons::after {
      content: "Fotos";
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
    .nav-tab[data-tab="logbook"] .material-icons::after {
      content: "Bit√°cora";
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
    .nav-tab[data-tab="result"] .material-icons::after {
      content: "Resultado";
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
    .nav-tab[data-tab="print"] .material-icons::after {
      content: "Imprimir";
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
    
    /* Variables */
    :root {
      --primary-color: #FF5252;
      --primary-dark: #C50E29;
      --primary-light: #FF867F;
      --secondary-color: #4CAF50;
      --background-color: #F9F9F9;
      --surface-color: #FFFFFF;
      --text-color: #333333;
      --text-secondary: #757575;
      --border-radius: 12px;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes scaleIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    /* Header */
    .app-header {
      background-color: var(--primary-color);
      color: white;
      padding: 16px 20px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .header-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .app-title {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .app-title .material-icons {
      font-size: 28px;
    }
    
    .recipe-input {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: var(--transition);
    }
    
    .recipe-input:focus {
      outline: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Contenedor principal */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 80px; /* Espacio para el men√∫ inferior */
    }
    
    /* Tarjetas */
    .card {
      background-color: var(--surface-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.3s ease-out;
    }
    
    .card h2 {
      margin-top: 0;
      margin-bottom: 16px;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 20px;
    }
    
    /* Formularios */
    .form-group {
      margin-bottom: 16px;
    }
    
    .input-label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .text-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e0e0e0;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-family: 'Poppins', sans-serif;
      transition: var(--transition);
    }
    
    .text-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(255,82,82,0.2);
    }
    
    .protected-input {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23FF5252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: calc(100% - 10px) 10px;
      background-size: 18px;
      padding-right: 36px;
      border-left: 3px solid #FF5252;
    }
    
    .input-row {
      display: flex;
      gap: 12px;
    }
    
    .input-row > * {
      flex: 1;
    }
    
    select.text-input {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23757575' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 36px;
      appearance: none;
    }
    
    /* Botones */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 500;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
      box-shadow: 0 4px 8px rgba(197,14,41,0.3);
    }
    
    .btn-primary:active {
      transform: translateY(1px);
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .btn-block {
      width: 100%;
    }
    
    .btn-icon {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .btn-icon:hover {
      background-color: rgba(0,0,0,0.05);
      color: var(--primary-color);
    }
    
    /* Pesta√±as de navegaci√≥n inferior */
    .nav-tabs {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background-color: var(--surface-color);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 10;
    }
    
    .nav-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-size: 12px;
    }
    
    .nav-tab .material-icons {
      font-size: 24px;
      margin-bottom: 4px;
    }
    
    .nav-tab.active {
      color: var(--primary-color);
    }
    
    /* Contenido de pesta√±as */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Listas */
    .list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .list-item {
      padding: 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: fadeIn 0.3s ease-out;
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    .list-item-content {
      flex: 1;
    }
    
    .list-item-title {
      font-weight: 500;
      margin: 0;
    }
    
    .list-item-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin: 4px 0 0;
    }
    
    .list-item-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-price {
      background-color: rgba(76, 175, 80, 0.15);
      color: #2e7d32;
    }
    
    /* Grillas de fotos */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    
    .photo-item {
      overflow: hidden;
      border-radius: var(--border-radius);
      background-color: #f0f0f0;
      position: relative;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
    }
    
    .photo-category-section {
      margin-bottom: 24px;
    }
    
    .photo-gallery {
      width: 100%;
    }
    
    .photo-metadata {
      background-color: #f5f5f5;
      padding: 8px;
      border-top: 1px solid #e0e0e0;
      font-size: 11px;
    }
    
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }
    
    .photo-item:hover img {
      transform: scale(1.05);
    }
    
    .photo-number {
      position: absolute;
      top: 8px;
      left: 8px;
    }
    
    .photo-delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
      z-index: 10;
      opacity: 0;
      transform: scale(0.8);
    }
    
    .photo-item:hover .photo-delete-btn {
      opacity: 1;
      transform: scale(1);
    }
    
    .photo-delete-btn:hover {
      background-color: rgba(255, 0, 0, 1);
      transform: scale(1.1);
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1;
    }
    
    .photo-category-section {
      margin-bottom: 16px;
    }
    
    .photo-gallery {
      width: 100%;
    }
    
    .photo-metadata {
      background-color: #f5f5f5;
      padding: 8px;
      border-top: 1px solid #e0e0e0;
      font-size: 11px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .photo-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px;
      font-size: 10px;
      transition: var(--transition);
      transform: translateY(100%);
    }
    
    .photo-item:hover .photo-info {
      transform: translateY(0);
    }
    
    .photo-date {
      font-weight: 500;
      margin-bottom: 2px;
    }
    
    .photo-location {
      font-size: 9px;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Dise√±o espec√≠fico para entrada de archivo */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      cursor: pointer;
      width: 100%;
    }
    
    .file-input-wrapper input[type="file"] {
      opacity: 0;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-button {
      background-color: #f0f0f0;
      color: var(--text-secondary);
      border: 2px dashed #ccc;
      border-radius: var(--border-radius);
      padding: 16px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition);
    }
    
    .file-input-button:hover {
      background-color: #e8e8e8;
      border-color: var(--primary-color);
    }
    
    /* Tarjeta de resumen */
    .summary-card {
      border-left: 4px solid var(--primary-color);
      padding-left: 16px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .summary-label {
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .summary-value {
      font-weight: 600;
    }
    
    .summary-value.highlight {
      color: var(--primary-color);
      font-size: 18px;
    }
    
    /* Media queries para diferentes tama√±os de pantalla */
    @media (min-width: 768px) {
      .app-header {
        padding: 20px 24px;
      }
      
      .header-content {
        flex-direction: row;
        justify-content: space-between;
      }
      
      .app-title {
        margin-right: 24px;
      }
      
      .recipe-input {
        max-width: 400px;
      }
      
      .nav-tabs {
        position: static;
        margin-bottom: 24px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
      }
      
      .container {
        padding: 24px;
        padding-bottom: 24px;
      }
      
      .photo-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* Estilos espec√≠ficos para la bit√°cora */
    .logbook-entry-item {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .logbook-entry-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .logbook-action-buttons button {
      transition: all 0.2s ease;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .logbook-action-buttons button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    @media (max-width: 600px) {
      .logbook-action-buttons {
        flex-direction: column;
        gap: 4px !important;
      }
      
      .logbook-action-buttons button {
        width: 100%;
        justify-content: center;
      }
      
      .logbook-action-buttons button span:last-child {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <h1 class="app-title">
        <span class="material-icons">restaurant</span>
        Recetas Chef Per√∫
      </h1>
      <input type="text" class="recipe-input" id="recipe-title" placeholder="Nombre de la receta...">
      
      <!-- Campo para logo/imagen del reporte -->
      <div style="margin-top: 12px; display: flex; align-items: center; gap: 12px;">
        <div class="file-input-wrapper" style="width: auto;">
          <div class="file-input-button" style="padding: 8px 12px; font-size: 14px;">
            <span class="material-icons" style="font-size: 18px;">image</span>
            Logo del Reporte
          </div>
          <input type="file" id="report-logo" accept="image/*">
        </div>
        <div id="logo-preview" style="display: none;">
          <img id="logo-image" src="" alt="Logo" style="max-height: 40px; border-radius: 4px; border: 1px solid #ddd;">
          <button id="remove-logo" style="background: none; border: none; color: #f44336; margin-left: 8px; cursor: pointer;">
            <span class="material-icons" style="font-size: 16px;">close</span>
          </button>
        </div>
      </div>
    </div>
    <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
      <button id="reset-all-header" class="btn" style="background-color: #F44336; color: white; padding: 8px 12px; font-size: 14px;">
        <span class="material-icons" style="font-size: 16px;">delete_forever</span>
        Borrar Todo
      </button>
    </div>
  </header>
  
  <!-- Contenedor principal -->
  <div class="container">
    <!-- Contenido de la pesta√±a Ingredientes -->
    <div class="tab-content active" id="ingredients-tab">
      <div class="card">
        <h2>Ingredientes</h2>
        
        <div class="form-group">
          <label class="input-label" for="ingredient-name">Nombre del ingrediente</label>
          <input type="text" class="text-input" id="ingredient-name" placeholder="Ej: Harina de trigo">
        </div>
        
        <div class="form-group">
          <div class="input-row">
            <div>
              <label class="input-label" for="ingredient-quantity">Cantidad</label>
              <input type="number" class="text-input" id="ingredient-quantity" placeholder="Ej: 500">
            </div>
            <div>
              <label class="input-label" for="ingredient-unit">Unidad</label>
              <select class="text-input" id="ingredient-unit">
                <option value="g">gramos (g)</option>
                <option value="kg">kilogramos (kg)</option>
                <option value="ml">mililitros (ml)</option>
                <option value="l">litros (l)</option>
                <option value="unidad">unidad(es)</option>
                <option value="cucharada">cucharada(s)</option>
                <option value="taza">taza(s)</option>
                <option value="pizca">pizca(s)</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="input-label" for="ingredient-price">Precio unitario (S/)</label>
          <input type="number" class="text-input" id="ingredient-price" placeholder="Ej: 25.50">
        </div>
        <div class="form-group">
          <div style="display: flex; align-items: center; justify-content: space-between; background-color: #f8f9fa; padding: 10px; border-radius: 8px;">
            <span id="price-calculation-label" style="color: var(--text-secondary);">Costo total: -</span>
            <button type="button" class="btn-icon" id="refresh-price" style="color: #1976D2; background-color: #e3f2fd; padding: 8px; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
              <span class="material-icons" style="font-size: 20px;">refresh</span>
            </button>
          </div>
        </div>
        
        <button class="btn btn-primary btn-block" id="add-ingredient">
          <span class="material-icons">add</span>
          Agregar Ingrediente
        </button>
        
        <div style="margin-top: 24px;">
          <h3 style="color: var(--text-secondary); font-size: 16px; font-weight: 500;">Lista de ingredientes</h3>
          <div class="summary-card" style="margin-bottom: 16px;">
            <div class="summary-row">
              <span class="summary-label">Costo total:</span>
              <span class="summary-value" id="ingredients-total-cost">S/0.00</span>
            </div>
          </div>
          <ul class="list" id="ingredients-list">
            <!-- Los ingredientes se agregar√°n aqu√≠ mediante JavaScript -->
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Contenido de la pesta√±a Preparaci√≥n -->
    <div class="tab-content" id="preparation-tab">
      <div class="card">
        <h2>Preparaci√≥n</h2>
        
        <div class="form-group">
          <label class="input-label" for="preparation-step">Describe el paso</label>
          <textarea class="text-input protected-input" id="preparation-step" rows="3" 
            placeholder="Ej: Mezclar la harina con la levadura..." 
            onpaste="showToast('No se permite pegar texto en la preparaci√≥n', 'error'); return false;" 
            oncopy="showToast('No se permite copiar texto de la preparaci√≥n', 'error'); return false;"
            oncontextmenu="showToast('No se permite copiar/pegar en esta √°rea', 'error'); return false;"></textarea>
          <div class="input-hint" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
            No se permite copiar ni pegar texto en la preparaci√≥n
          </div>
        </div>
        
        <button class="btn btn-primary btn-block" id="add-step">
          <span class="material-icons">playlist_add</span>
          Agregar Paso
        </button>
        
        <button class="btn btn-secondary btn-block" id="cancel-edit-step" style="display: none; margin-top: 8px;">
          <span class="material-icons">cancel</span>
          Cancelar Edici√≥n
        </button>
        
        <div style="margin-top: 24px;">
          <h3 style="color: var(--text-secondary); font-size: 16px; font-weight: 500;">Pasos a seguir</h3>
          <div class="steps-container" style="background-color: #f9f9f9; border-radius: 8px; padding: 16px;">
            <ol class="list" id="steps-list" style="padding-left: 24px; margin-bottom: 0;">
              <!-- Los pasos se agregar√°n aqu√≠ mediante JavaScript -->
            </ol>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Contenido de la pesta√±a Fotos -->
    <div class="tab-content" id="photos-tab">
      <div class="card">
        <h2>ANTES de la preparaci√≥n</h2>
        <p style="color: var(--text-secondary); margin-top: -8px; margin-bottom: 12px;">Fotos de los ingredientes antes de iniciar la preparaci√≥n</p>
        <div style="background-color: #f9f4e8; padding: 8px 12px; border-radius: 8px; margin-bottom: 12px;">
          <span style="color: var(--primary-color); font-weight: 600;">A1, A2, A3...</span> Fotos numeradas autom√°ticamente con fecha y ubicaci√≥n
          <br><small id="before-photo-limit" style="color: #666;"></small>
        </div>
        
        <div class="file-input-wrapper">
          <div class="file-input-button">
            <span class="material-icons">add_photo_alternate</span>
            <span>Seleccionar fotos de ANTES</span>
          </div>
          <input type="file" id="photo-before" accept="image/*" multiple>
        </div>
        
        <div class="form-group" style="margin-top: 16px;">
          <label class="input-label" for="description-before">Descripci√≥n</label>
          <textarea class="text-input" id="description-before" rows="2" placeholder="Describe las fotos..."></textarea>
        </div>
        
        <button class="btn btn-secondary" id="save-before">
          <span class="material-icons">save</span>
          Guardar descripci√≥n
        </button>
        
        <div class="photo-grid" id="before-photos">
          <!-- Las fotos se mostrar√°n aqu√≠ -->
        </div>
      </div>
      
      <div class="card">
        <h2>DURANTE la preparaci√≥n</h2>
        <p style="color: var(--text-secondary); margin-top: -8px; margin-bottom: 12px;">Fotos del proceso de preparaci√≥n en curso</p>
        <div style="background-color: #f9f4e8; padding: 8px 12px; border-radius: 8px; margin-bottom: 12px;">
          <span style="color: var(--primary-color); font-weight: 600;">D1, D2, D3...</span> Fotos numeradas autom√°ticamente con fecha y ubicaci√≥n
          <br><small id="during-photo-limit" style="color: #666;"></small>
        </div>
        
        <div class="file-input-wrapper">
          <div class="file-input-button">
            <span class="material-icons">add_photo_alternate</span>
            <span>Seleccionar fotos de DURANTE</span>
          </div>
          <input type="file" id="photo-during" accept="image/*" multiple>
        </div>
        
        <div class="form-group" style="margin-top: 16px;">
          <label class="input-label" for="description-during">Descripci√≥n</label>
          <textarea class="text-input" id="description-during" rows="2" placeholder="Describe las fotos..."></textarea>
        </div>
        
        <button class="btn btn-secondary" id="save-during">
          <span class="material-icons">save</span>
          Guardar descripci√≥n
        </button>
        
        <div class="photo-grid" id="during-photos">
          <!-- Las fotos se mostrar√°n aqu√≠ -->
        </div>
      </div>
      
      <div class="card">
        <h2>DESPU√âS de la preparaci√≥n</h2>
        <p style="color: var(--text-secondary); margin-top: -8px; margin-bottom: 12px;">Fotos del resultado final y la presentaci√≥n del plato</p>
        <div style="background-color: #f9f4e8; padding: 8px 12px; border-radius: 8px; margin-bottom: 12px;">
          <span style="color: var(--primary-color); font-weight: 600;">P1, P2, P3...</span> Fotos numeradas autom√°ticamente con fecha y ubicaci√≥n
          <br><small id="after-photo-limit" style="color: #666;"></small>
        </div>
        
        <div class="file-input-wrapper">
          <div class="file-input-button">
            <span class="material-icons">add_photo_alternate</span>
            <span>Seleccionar fotos de DESPU√âS</span>
          </div>
          <input type="file" id="photo-after" accept="image/*" multiple>
        </div>
        
        <div class="form-group" style="margin-top: 16px;">
          <label class="input-label" for="description-after">Descripci√≥n</label>
          <textarea class="text-input" id="description-after" rows="2" placeholder="Describe las fotos..."></textarea>
        </div>
        
        <button class="btn btn-secondary" id="save-after">
          <span class="material-icons">save</span>
          Guardar descripci√≥n
        </button>
        
        <div class="photo-grid" id="after-photos">
          <!-- Las fotos se mostrar√°n aqu√≠ -->
        </div>
      </div>
    </div>
    
    <!-- Contenido de la pesta√±a Bit√°cora -->
    <div class="tab-content" id="logbook-tab">
      <div class="card">
        <h2>Bit√°cora de Trabajo</h2>
        
        <div class="form-group">
          <label class="input-label" for="logbook-date">Fecha</label>
          <input type="date" class="text-input" id="logbook-date">
        </div>
        
        <div class="form-group">
          <label class="input-label" for="logbook-title">T√≠tulo de la anotaci√≥n</label>
          <input type="text" class="text-input" id="logbook-title" placeholder="Ej: Problema con suministros">
        </div>
        
        <div class="form-group">
          <label class="input-label" for="logbook-category">Categor√≠a</label>
          <select class="text-input" id="logbook-category">
            <option value="materiales">Materiales/Ingredientes</option>
            <option value="equipo">Equipo de trabajo</option>
            <option value="proceso">Proceso de preparaci√≥n</option>
            <option value="cliente">Cliente/Requisitos</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="input-label" for="logbook-text">Descripci√≥n</label>
          <textarea class="text-input" id="logbook-text" rows="4" placeholder="Describe detalladamente lo sucedido..."></textarea>
        </div>
        
        <button class="btn btn-primary btn-block" id="add-logbook-entry">
          <span class="material-icons">add</span>
          Agregar Anotaci√≥n
        </button>
        
        <button class="btn btn-secondary btn-block" id="cancel-edit-logbook" style="display: none; margin-top: 8px;">
          <span class="material-icons">cancel</span>
          Cancelar Edici√≥n
        </button>
        
        <div style="margin-top: 24px;">
          <h3 style="color: var(--text-secondary); font-size: 16px; font-weight: 500;">Anotaciones</h3>
          <ul class="list" id="logbook-entries-list">
            <!-- Las anotaciones se agregar√°n aqu√≠ mediante JavaScript -->
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Contenido de la pesta√±a Resultado -->
    <div class="tab-content" id="result-tab">
      <div class="card">
        <h2>Resultado Final</h2>
        
        <div id="author-info" style="background-color: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
          <h3 style="color: var(--primary-color); font-size: 18px; margin-top: 0;">Informaci√≥n del Chef</h3>
          <div class="form-group">
            <label class="input-label" for="chef-name">Nombre del Chef</label>
            <input type="text" class="text-input" id="chef-name" placeholder="Ingrese su nombre">
          </div>
        </div>
        
        <div class="summary-card">
          <div class="summary-row" style="background-color: var(--primary-color); color: white; border-radius: 8px 8px 0 0; padding: 12px 16px;">
            <span style="font-size: 18px; font-weight: 600;">Resumen de la Receta</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">T√≠tulo:</span>
            <span class="summary-value" id="summary-title">-</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">Chef:</span>
            <span class="summary-value" id="summary-chef">-</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">Total de ingredientes:</span>
            <span class="summary-value" id="summary-ingredients">0</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">Pasos de preparaci√≥n:</span>
            <span class="summary-value" id="summary-steps">0</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">Fotos agregadas:</span>
            <span class="summary-value" id="summary-photos">0</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">Anotaciones bit√°cora:</span>
            <span class="summary-value" id="summary-logbook">0</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">Fecha de creaci√≥n:</span>
            <span class="summary-value" id="summary-date">26/09/2025</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">Costo total:</span>
            <span class="summary-value" id="summary-cost">S/0.00</span>
          </div>
          
          <div class="summary-row">
            <span class="summary-label">Precio sugerido (30% margen):</span>
            <span class="summary-value highlight" id="suggested-price">S/0.00</span>
          </div>
        </div>

        <!-- Visor de fotos de evidencia -->
        <div style="margin-top: 24px;">
          <h3 style="color: var(--primary-color); font-size: 18px; font-weight: 600;">Fotos de Evidencia</h3>
          
          <div class="photos-container" style="border: 1px solid #eee; border-radius: 8px; overflow: hidden; padding: 16px;">
            <div class="photo-category-section">
              <h4 style="color: var(--primary-color); font-size: 16px; margin: 0 0 12px 0; font-weight: 600;">ANTES</h4>
              <div class="photo-gallery" id="summary-before-photos" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                <!-- Fotos ANTES -->
              </div>
            </div>
            
            <div class="photo-category-section" style="margin-top: 24px;">
              <h4 style="color: var(--primary-color); font-size: 16px; margin: 0 0 12px 0; font-weight: 600;">DURANTE</h4>
              <div class="photo-gallery" id="summary-during-photos" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                <!-- Fotos DURANTE -->
              </div>
            </div>
            
            <div class="photo-category-section" style="margin-top: 24px;">
              <h4 style="color: var(--primary-color); font-size: 16px; margin: 0 0 12px 0; font-weight: 600;">DESPU√âS</h4>
              <div class="photo-gallery" id="summary-after-photos" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                <!-- Fotos DESPU√âS -->
              </div>
            </div>
          </div>
          </div>
        </div>
        
        <div style="margin-top: 24px;">
          <h3 style="color: var(--primary-color); font-size: 18px; font-weight: 600;">Punto de Equilibrio</h3>
          
          <div class="alert" style="background-color: #FFF8E1; border-left: 4px solid #FFC107; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
            <p><strong>¬øQu√© es el punto de equilibrio?</strong></p>
            <p style="margin-top: 8px;">El punto de equilibrio es el nivel de ventas donde los ingresos totales son iguales a los costos totales, es decir, el punto donde no hay ganancias ni p√©rdidas.</p>
            <p style="margin-top: 8px;"><strong>F√≥rmula:</strong> Punto de Equilibrio = Costos Fijos / (Precio de Venta - Costo Variable Unitario)</p>
            <p style="margin-top: 5px;"><strong>Ejemplo:</strong> Si tus costos fijos son S/500, el precio de venta es S/7 y el costo variable unitario es S/5, el punto de equilibrio ser√≠a 250 unidades. Esto significa que a partir de la unidad 251 empezar√≠as a generar ganancias.</p>
          </div>
          
          <div class="alert" style="background-color: #E3F2FD; border-left: 4px solid #2196F3; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
            <h4 style="margin: 0 0 8px 0; color: #1565C0; font-size: 16px;">üéØ Experimento Educativo</h4>
            <p style="margin: 0; color: #1976D2;">
              <strong>¬øQu√© pasa si mis ingredientes no cuestan nada?</strong><br>
              Si extraes productos de la naturaleza (frutas silvestres, hierbas, etc.) o tienes ingredientes "gratis", 
              pon <strong>precio 0</strong> en tus ingredientes y experimenta c√≥mo cambia tu an√°lisis de ganancia.
              <br><br>
              üí° <strong>Pregunta para reflexionar:</strong> ¬øC√≥mo afecta tener costos cero en mi estrategia de precios?
            </p>
          </div>
          
          <div class="alert" style="background-color: #E8F5E8; border-left: 4px solid #4CAF50; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
            <h4 style="margin: 0 0 8px 0; color: #2E7D32; font-size: 16px;">üí∞ Informaci√≥n de Costos Base</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: center;">
              <div>
                <strong>Costo total de ingredientes:</strong><br>
                <span id="costo-ingredientes-display" style="font-size: 18px; color: #2E7D32; font-weight: 600;">S/0.00</span>
              </div>
              <div>
                <strong>Costo por unidad de ingredientes:</strong><br>
                <span id="costo-unitario-ingredientes" style="font-size: 18px; color: #1976D2; font-weight: 600;">S/0.00</span>
              </div>
            </div>
            <div id="analisis-precio" style="margin-top: 12px; padding: 8px; border-radius: 4px; display: none;">
              <strong>An√°lisis de tu precio:</strong><br>
              <span id="resultado-analisis" style="font-weight: 600;"></span>
            </div>
          </div>

          <div class="form-group">
            <label class="input-label" for="rendimiento-ingredientes">¬øPara cu√°ntas unidades rinden estos ingredientes?</label>
            <input type="number" step="1" min="1" class="text-input" id="rendimiento-ingredientes" placeholder="Ej: 15">
            <small style="display: block; color: #666; margin-top: 4px;">Con el dinero gastado en ingredientes, ¬øcu√°ntos productos completos puedes hacer? Esto define el costo real por unidad.</small>
          </div>

          <div class="form-group">
            <label class="input-label" for="costos-fijos">Costos fijos (S/)</label>
            <input type="number" step="0.01" class="text-input" id="costos-fijos" placeholder="Ej: alquiler, servicios, etc.">
            <small style="display: block; color: #666; margin-top: 4px;">Son los costos que no cambian con la cantidad producida (alquiler, salarios fijos, servicios b√°sicos)</small>
          </div>
          
          <div class="form-group">
            <label class="input-label" for="costo-unitario-extra">Costo unitario extra (S/)</label>
            <input type="number" step="0.01" class="text-input" id="costo-unitario-extra" placeholder="Costos adicionales por unidad">
            <small style="display: block; color: #666; margin-top: 4px;">Costos variables por unidad adicionales a los ingredientes (envases, etiquetas, delivery)</small>
          </div>
          
          <div class="form-group">
            <label class="input-label" for="precio-venta">Precio de venta por unidad (S/)</label>
            <input type="number" step="0.01" class="text-input" id="precio-venta" placeholder="Calcula tu precio considerando costos y ganancia deseada">
            <small style="display: block; color: #666; margin-top: 4px;">El precio al que vender√°s cada unidad de tu producto. Debe cubrir costos y generar ganancia.</small>
          </div>

          <div class="form-group">
            <label class="input-label" for="cantidad-producida">Cantidad a producir (unidades)</label>
            <input type="number" step="1" class="text-input" id="cantidad-producida" placeholder="Se copia autom√°ticamente" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
            <small style="display: block; color: #666; margin-top: 4px;">Este valor se copia autom√°ticamente del rendimiento de ingredientes. Es la base para el c√°lculo del punto de equilibrio.</small>
          </div>
          
          <button class="btn btn-secondary" id="calcular-equilibrio">
            <span class="material-icons">calculate</span>
            Calcular Punto de Equilibrio
          </button>
          
          <!-- √Årea de mensajes din√°micos educativos -->
          <div id="mensaje-educativo" style="margin: 16px 0; padding: 16px; border-radius: 8px; display: none;">
            <div id="contenido-mensaje"></div>
          </div>
          
          <div class="summary-card" style="margin-top: 16px;">
            <div class="summary-row">
              <span class="summary-label">Punto de equilibrio (unidades):</span>
              <span class="summary-value" id="punto-equilibrio-unidades">0</span>
            </div>
            
            <div class="summary-row">
              <span class="summary-label">Ingresos en punto de equilibrio:</span>
              <span class="summary-value" id="punto-equilibrio-ingresos">S/0.00</span>
            </div>
            
            <div class="summary-row" style="background-color: #f5f5f5; padding: 8px;">
              <span class="summary-label">Interpretaci√≥n:</span>
              <span class="summary-value" style="font-weight: normal; font-size: 13px;">A partir de la unidad siguiente al punto de equilibrio comenzar√°s a generar ganancias</span>
            </div>
          </div>
          
          <div style="margin-top: 24px;">
            <h4 style="color: var(--text-secondary); font-size: 16px; margin-bottom: 12px;">Gr√°fica de Punto de Equilibrio</h4>
            <div id="breakeven-chart-container" class="chart-container" style="position: relative; min-height: 300px; border: 1px solid #eee; border-radius: 8px; padding: 16px; text-align: center;">
              <p style="color: #666; font-style: italic; padding: 60px 20px;">
                Haz clic en "Calcular Punto de Equilibrio" para generar el gr√°fico.
              </p>
            </div>
            <p style="color: var(--text-secondary); font-size: 12px; text-align: center; margin-top: 8px;">
              La gr√°fica muestra los costos fijos (l√≠nea horizontal), costos variables (l√≠nea inclinada) e ingresos (l√≠nea inclinada).
              El punto donde se cruzan los costos totales y los ingresos es el punto de equilibrio.
            </p>
          </div>
        </div>
        
        <!-- Botones temporalmente eliminados -->
        <div style="margin-top: 24px;" class="botones-ocultos">
          <!-- Los botones de Generar PDF, Compartir Receta y BORRAR TODO fueron eliminados por solicitud del usuario -->
        </div>
      </div>
    </div>
    <!-- Contenido de la pesta√±a Imprimir -->
    <div class="tab-content" id="print-tab">
      <div class="card">
        <h2>Resumen para Imprimir</h2>
        <p>Aqu√≠ tienes una vista previa de c√≥mo se ver√° tu receta. Usa el bot√≥n de abajo para imprimir o guardar como PDF.</p>
        
        <div class="print-controls">
          <button id="prepare-print-btn" class="btn btn-secondary">
            <span class="material-icons">refresh</span> Actualizar Vista Previa
          </button>
          <button id="print-btn" class="btn">
            <span class="material-icons">print</span> Imprimir Receta
          </button>
        </div>

        <div id="print-content-wrapper">
          <div id="print-content">
            <!-- El contenido de la receta se generar√° aqu√≠ -->
            <p style="text-align:center; color:var(--text-secondary); padding:32px;">
              Haz clic en "Actualizar Vista Previa" para generar el resumen de tu receta.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  

  <!-- Navegaci√≥n de pesta√±as en la parte inferior -->
  <nav class="nav-tabs">
    <div class="nav-tab active" data-tab="ingredients">
      <span class="material-icons">shopping_cart</span>
      Ingredientes
    </div>
    <div class="nav-tab" data-tab="preparation">
      <span class="material-icons">format_list_numbered</span>
      Preparaci√≥n
    </div>
    <div class="nav-tab" data-tab="photos">
      <span class="material-icons">photo_camera</span>
      Fotos
    </div>
    <div class="nav-tab" data-tab="logbook">
      <span class="material-icons">book</span>
      Bit√°cora
    </div>
    <div class="nav-tab" data-tab="result">
      <span class="material-icons">assessment</span>
      Resultado
    </div>
    <div class="nav-tab" data-tab="print">
      <span class="material-icons">print</span>
      Imprimir
    </div>
  </nav>
<!-- Footer con informaci√≥n de copyright -->
  <footer style="text-align: center; padding: 20px; background-color: #333; color: white; font-size: 12px; margin-bottom: 60px;">
    Desarrollado por MAxSystem<br>
    Contacto: edir77@gmail.com | WhatsApp: +51 925 679 932<br>
    Todos los derechos reservados &copy; 2025
  </footer>
  
  <script>
    // Funci√≥n para corregir textos de la barra de navegaci√≥n
    function corregirTextosNavegacion() {
      const traducciones = {
        'shopping_cart': 'Ingredientes',
        'format_list_numbered': 'Preparaci√≥n',
        'photo_camera': 'Fotos',
        'book': 'Bit√°cora',
        'assessment': 'Resultado',
        'print': 'Imprimir'
      };
      
      const navTabs = document.querySelectorAll('.nav-tab');
      navTabs.forEach(tab => {
        const icon = tab.querySelector('.material-icons');
        if (icon) {
          const iconText = icon.textContent.trim();
          
          // Buscar si hay un nodo de texto despu√©s del icono
          let textNode = null;
          tab.childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
              textNode = node;
            }
          });
          
          if (textNode) {
            // Si el texto est√° en ingl√©s (es el mismo que el icono) o est√° vac√≠o, reemplazarlo
            const currentText = textNode.textContent.trim();
            if (currentText === iconText || !currentText) {
              if (traducciones[iconText]) {
                textNode.textContent = " " + traducciones[iconText];
              }
            }
          } else if (traducciones[iconText]) {
            // Si no hay texto, a√±adirlo
            tab.appendChild(document.createTextNode(" " + traducciones[iconText]));
          }
        }
      });
    }
    
    // Encapsular todo el c√≥digo en DOMContentLoaded para asegurar que el DOM est√° completamente cargado
    
    // Variables globales - Inicializar al principio para evitar errores
    let ingredients = [];
    let steps = [];
    let editingStepIndex = -1;
    let logbookEntries = [];
    let editingLogbookIndex = -1;
    
    // Configuraci√≥n de fotos seg√∫n conexi√≥n
    let photoConfig = {
      maxPhotosOnline: 50,
      maxPhotosOffline: 10,
      compressionQuality: 0.6,
      maxWidth: 800
    };
    
    // Funci√≥n para detectar si estamos online
    function isOnline() {
      return navigator.onLine;
    }
    
    // Funci√≥n para obtener l√≠mite de fotos seg√∫n conexi√≥n
    function getMaxPhotos() {
      return isOnline() ? photoConfig.maxPhotosOnline : photoConfig.maxPhotosOffline;
    }
    
    // Funci√≥n para verificar y limpiar localStorage si est√° lleno
    function checkStorageQuota() {
      try {
        const test = 'test';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch (e) {
        console.warn('localStorage lleno, limpiando fotos antiguas...');
        cleanOldPhotos();
        return false;
      }
    }
    
    // Funci√≥n para actualizar indicadores de l√≠mite de fotos
    function updatePhotoLimitIndicators() {
      const maxPhotosPerCategory = 10; // L√≠mite fijo por categor√≠a
      const isOnlineStatus = isOnline();
      const statusText = isOnlineStatus ? 'Online' : 'Offline';
      const statusColor = isOnlineStatus ? '#4CAF50' : '#FF9800';
      
      console.log('Actualizando indicadores de fotos:', { maxPhotosPerCategory, isOnlineStatus });
      
      ['before', 'during', 'after'].forEach(category => {
        const storageKey = `${category}-photos-photos`;
        const currentPhotos = JSON.parse(localStorage.getItem(storageKey) || '[]').length;
        const indicator = document.getElementById(`${category}-photo-limit`);
        
        console.log(`${category}: ${currentPhotos}/${maxPhotosPerCategory} fotos, elemento:`, indicator);
        
        if (indicator) {
          const warningText = currentPhotos >= maxPhotosPerCategory 
            ? '<span style="color: #f44336;">‚ö†Ô∏è L√≠mite alcanzado</span>' 
            : '';
          
          indicator.innerHTML = `
            <span style="color: ${statusColor};">üì° ${statusText}</span> - 
            ${currentPhotos}/${maxPhotosPerCategory} fotos
            ${warningText}
          `;
          console.log(`Indicador actualizado para ${category}`);
        } else {
          console.warn(`Elemento ${category}-photo-limit no encontrado`);
        }
      });
    }
    
    // Actualizar indicadores cuando cambie el estado de conexi√≥n
    window.addEventListener('online', updatePhotoLimitIndicators);
    window.addEventListener('offline', updatePhotoLimitIndicators);
    
    // Funci√≥n para limpiar fotos antiguas cuando localStorage est√° lleno
    function cleanOldPhotos() {
      const photoKeys = ['before-photos-photos', 'during-photos-photos', 'after-photos-photos'];
      photoKeys.forEach(key => {
        const photos = JSON.parse(localStorage.getItem(key) || '[]');
        if (photos.length > 5) {
          const reducedPhotos = photos.slice(-5); // Mantener solo las √∫ltimas 5
          localStorage.setItem(key, JSON.stringify(reducedPhotos));
          console.log(`Reducidas fotos en ${key} a ${reducedPhotos.length}`);
        }
      });
      // Actualizar indicadores despu√©s de limpiar
      updatePhotoLimitIndicators();
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Protecci√≥n real contra copiar/pegar/contextmenu en preparaci√≥n
      const prepStep = document.getElementById('preparation-step');
      if (prepStep) {
        prepStep.addEventListener('cut', function(e) {
          e.preventDefault();
          showToast('No se permite cortar texto de la preparaci√≥n', 'error');
        });
        prepStep.addEventListener('paste', function(e) {
          e.preventDefault();
          showToast('No se permite pegar texto en la preparaci√≥n', 'error');
        });
        prepStep.addEventListener('copy', function(e) {
          e.preventDefault();
          showToast('No se permite copiar texto de la preparaci√≥n', 'error');
        });
        prepStep.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          showToast('No se permite copiar/pegar en esta √°rea', 'error');
        });
      }
      console.log('Inicializando la aplicaci√≥n...');
      
      // Recuperar datos del almacenamiento local ANTES de llamar updateSummary
      const savedIngredients = localStorage.getItem('ingredients');
      if (savedIngredients) {
        ingredients = JSON.parse(savedIngredients);
      }
      
      const savedSteps = localStorage.getItem('steps');
      if (savedSteps) {
        steps = JSON.parse(savedSteps);
      }
      
      const savedLogbookEntries = localStorage.getItem('logbook-entries');
      if (savedLogbookEntries) {
        logbookEntries = JSON.parse(savedLogbookEntries);
      }
      
      // Verificar quota de storage
      checkStorageQuota();
      
      // Actualizar indicadores de l√≠mite de fotos
      updatePhotoLimitIndicators();
      
      // Actualizar resumen y fotos del resumen DESPU√âS de cargar datos
      updateSummary();
      updateSummaryPhotos();
      
      // Cargar fotos inmediatamente al iniciar la aplicaci√≥n
      setTimeout(function() {
        console.log('Inicializando fotos...');
        // Cargar fotos guardadas de forma segura
        loadSavedPhotos();
        
        // Actualizar las fotos en la secci√≥n de resumen despu√©s de cargar las fotos principales
        updateSummaryPhotos();
      }, 500);
      
      // Corregir textos de navegaci√≥n
      corregirTextosNavegacion();
      
      console.log('Configurando navegaci√≥n de pesta√±as...');
      
      // Verificar que la pesta√±a inicial est√© activa
      const initialTab = document.querySelector('.nav-tab.active');
      const initialContent = document.querySelector('.tab-content.active');
      console.log('Pesta√±a inicial:', initialTab ? initialTab.getAttribute('data-tab') : 'ninguna');
      console.log('Contenido inicial activo:', initialContent ? initialContent.id : 'ninguno');
    
    // Funcionalidad de las pesta√±as
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        console.log('Pesta√±a clickeada:', tab.getAttribute('data-tab'));
        // Desactivar todas las pesta√±as
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Activar la pesta√±a seleccionada
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab') + '-tab';
        const tabContent = document.getElementById(tabId);
        if (tabContent) {
          tabContent.classList.add('active');
          console.log('Pesta√±a activada:', tabId);
        } else {
          console.error('Contenido de pesta√±a no encontrado:', tabId);
        }
        
        // Si es la pesta√±a de imprimir o resultado, actualizar la vista correspondiente
        if (tabId === 'print-tab') {
          updatePrintView();
        } else if (tabId === 'result-tab') {
          updateSummary();
          updateSummaryPhotos();
          // Actualizar costos de punto de equilibrio
          if (window.updateBreakevenCosts) {
            window.updateBreakevenCosts();
          }
        }
        
        // Animaci√≥n para el contenido
        if (tabContent) {
          tabContent.style.animation = 'scaleIn 0.3s ease-out forwards';
        }
      });
    });
    
    // Resumen final de inicializaci√≥n
    console.log('=== RESUMEN DE INICIALIZACI√ìN ===');
    console.log('Ingredientes cargados:', ingredients.length);
    console.log('Pasos cargados:', steps.length);
    console.log('Anotaciones bit√°cora cargadas:', logbookEntries.length);
    console.log('Estado de conexi√≥n:', isOnline() ? 'Online' : 'Offline');
    console.log('L√≠mite de fotos:', getMaxPhotos());
    console.log('==================================');
    
    // Gesti√≥n de ingredientes
    const addIngredientBtn = document.getElementById('add-ingredient');
    const ingredientsList = document.getElementById('ingredients-list');
    
    // Verificar que los elementos existen
    console.log('Elemento addIngredientBtn:', addIngredientBtn ? 'Encontrado' : 'NO ENCONTRADO');
    console.log('Elemento ingredientsList:', ingredientsList ? 'Encontrado' : 'NO ENCONTRADO');
    
    // Los ingredientes ya fueron cargados al inicio
    if (ingredients.length > 0) {
      console.log('Cargando ingredientes al inicio:', ingredients.length);
      updateIngredientsList();
    } else {
      console.log('No hay ingredientes para cargar');
    }
    
    // Definir la funci√≥n para agregar ingrediente
    function addIngredient() {
      console.log('Funci√≥n addIngredient ejecutada');
      const name = document.getElementById('ingredient-name').value;
      const quantity = document.getElementById('ingredient-quantity').value;
      const unit = document.getElementById('ingredient-unit').value;
      const priceUnit = document.getElementById('ingredient-price').value;
      
      console.log('Valores del ingrediente:', { name, quantity, unit, priceUnit });
      
      if (name && quantity && priceUnit) {
        const quantityVal = parseFloat(quantity);
        const priceUnitVal = parseFloat(priceUnit);
        // Usar m√°xima precisi√≥n en el c√°lculo
        const totalPrice = parseFloat((quantityVal * priceUnitVal).toFixed(3));
        
        const ingredient = {
          id: Date.now(), // Usar timestamp como ID √∫nico
          name,
          quantity: quantityVal,
          unit,
          priceUnit: priceUnitVal,
          price: totalPrice
        };
        
        ingredients.push(ingredient);
        updateIngredientsList();
        saveIngredientsToStorage();
        
        // Limpiar formulario
        document.getElementById('ingredient-name').value = '';
        document.getElementById('ingredient-quantity').value = '';
        document.getElementById('ingredient-price').value = '';
        
        // Mostrar mensaje de √©xito
        showToast('Ingrediente agregado');
      } else {
        // Mostrar mensaje de error
        showToast('Por favor completa todos los campos', 'error');
      }
    }
    
    // Asignar el evento click al bot√≥n
    if (addIngredientBtn) {
      addIngredientBtn.addEventListener('click', addIngredient);
      console.log('Evento click asignado a addIngredientBtn');
    }
    
    function updateIngredientsList() {
      ingredientsList.innerHTML = '';
      
      // Calcular y mostrar el costo total
      let totalCost = 0;
      if (ingredients.length > 0) {
        totalCost = ingredients.reduce((sum, item) => sum + item.price, 0);
      }
      document.getElementById('ingredients-total-cost').textContent = `S/${totalCost.toFixed(2)}`;
      
      if (ingredients.length === 0) {
        ingredientsList.innerHTML = '<p style="text-align:center; color:var(--text-secondary); padding:16px;">No hay ingredientes agregados</p>';
        return;
      }
      
      ingredients.forEach((ingredient, index) => {
        const li = document.createElement('li');
        li.className = 'list-item';
        const priceUnit = ingredient.priceUnit || (ingredient.price / ingredient.quantity);
        
        li.innerHTML = `
          <div class="list-item-content">
            <h4 class="list-item-title">${ingredient.name}</h4>
            <p class="list-item-subtitle">
              ${ingredient.quantity} ${ingredient.unit}
              <span class="badge badge-price">S/${ingredient.price.toFixed(2)}</span>
            </p>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
              ${ingredient.quantity} x ${priceUnit.toFixed(3)} = ${ingredient.price.toFixed(3)} soles
            </p>
          </div>
          <div class="list-item-actions">
            <button class="btn-icon" onclick="editIngredient(${ingredient.id})">
              <span class="material-icons">edit</span>
            </button>
            <button class="btn-icon" onclick="deleteIngredient(${ingredient.id})">
              <span class="material-icons">delete</span>
            </button>
          </div>
        `;
        ingredientsList.appendChild(li);
      });
      
      // Solo actualizar el resumen si la funci√≥n existe
      if (typeof updateSummary === 'function') {
        updateSummary();
      }
    }
    
    function saveIngredientsToStorage() {
      localStorage.setItem('ingredients', JSON.stringify(ingredients));
    }
    
    // Funciones globales para manipular ingredientes
    window.deleteIngredient = function(id) {
      ingredients = ingredients.filter(item => item.id !== id);
      updateIngredientsList();
      saveIngredientsToStorage();
      showToast('Ingrediente eliminado');
    };
    
    window.editIngredient = function(id) {
      const ingredient = ingredients.find(item => item.id === id);
      if (ingredient) {
        document.getElementById('ingredient-name').value = ingredient.name;
        document.getElementById('ingredient-quantity').value = ingredient.quantity;
        document.getElementById('ingredient-unit').value = ingredient.unit;
        document.getElementById('ingredient-price').value = ingredient.price;
        
        // Eliminar el ingrediente actual, luego se volver√° a agregar al editar
        deleteIngredient(id);
        
        // Scroll al formulario
        document.getElementById('ingredient-name').scrollIntoView({behavior: 'smooth'});
        document.getElementById('ingredient-name').focus();
      }
    };
    
    // Gesti√≥n de pasos
    // steps ya fue inicializado como una variable global m√°s arriba
    const addStepButton = document.getElementById('add-step');
    const stepsList = document.getElementById('steps-list');
    
    // Verificar que los elementos existen
    console.log('Elemento addStepButton:', addStepButton ? 'Encontrado' : 'NO ENCONTRADO');
    console.log('Elemento stepsList:', stepsList ? 'Encontrado' : 'NO ENCONTRADO');
    
    // Los pasos ya fueron cargados al inicio
    if (steps.length > 0) {
      console.log('Cargando pasos al inicio:', steps.length);
      if (typeof updateStepsList === 'function') {
        updateStepsList();
      }
    } else {
      console.log('No hay pasos para cargar');
    }
    
    // Verificar si hay datos en localStorage cada vez que se carga la p√°gina
    function checkLocalStorage() {
      console.log('Verificando datos en localStorage:');
      console.log('Ingredientes:', localStorage.getItem('ingredients') ? 'Encontrados' : 'No encontrados');
      console.log('Pasos:', localStorage.getItem('steps') ? 'Encontrados' : 'No encontrados');
      console.log('Fotos ANTES:', localStorage.getItem('before-photos-photos') ? 'Encontradas' : 'No encontradas');
      console.log('Fotos DURANTE:', localStorage.getItem('during-photos-photos') ? 'Encontradas' : 'No encontradas');
      console.log('Fotos DESPU√âS:', localStorage.getItem('after-photos-photos') ? 'Encontradas' : 'No encontradas');
    }
    
    // Ejecutar verificaci√≥n al cargar
    checkLocalStorage();
    
    // Definir la funci√≥n para agregar paso
    function addStep() {
      console.log('Funci√≥n addStep ejecutada');
      const stepText = document.getElementById('preparation-step').value.trim();
      
      console.log('Texto del paso:', stepText);
      
      if (stepText) {
        if (editingStepIndex !== -1) {
          // Modo edici√≥n: actualizar el paso existente en su posici√≥n original
          steps[editingStepIndex].text = stepText;
          editingStepIndex = -1; // Resetear el √≠ndice de edici√≥n
          
          // Restaurar el bot√≥n a su estado normal
          const addButton = document.getElementById('add-step');
          const cancelButton = document.getElementById('cancel-edit-step');
          
          if (addButton) {
            addButton.innerHTML = '<span class="material-icons">playlist_add</span> Agregar Paso';
            addButton.style.backgroundColor = ''; // Restaurar color original
          }
          
          if (cancelButton) {
            cancelButton.style.display = 'none'; // Ocultar bot√≥n cancelar
          }
          
          showToast('Paso actualizado correctamente');
        } else {
          // Modo agregar: crear nuevo paso
          const step = {
            id: Date.now(),
            text: stepText
          };
          
          steps.push(step);
          showToast('Paso agregado');
        }
        
        updateStepsList();
        saveStepsToStorage();
        
        // Limpiar formulario
        document.getElementById('preparation-step').value = '';
      } else {
        // Mostrar mensaje de error
        showToast('Por favor ingresa un texto para el paso', 'error');
      }
    }
    
    // Asignar el evento click al bot√≥n
    if (addStepButton) {
      addStepButton.addEventListener('click', addStep);
      console.log('Evento click asignado a addStepButton');
    }
    
    function updateStepsList() {
      stepsList.innerHTML = '';
      
      if (steps.length === 0) {
        stepsList.innerHTML = '<p style="text-align:center; color:var(--text-secondary); padding:16px;">No hay pasos agregados</p>';
        return;
      }
      
      steps.forEach((step, index) => {
        const li = document.createElement('li');
        li.className = 'step-item';
        li.style.marginBottom = '16px';
        li.style.paddingLeft = '10px';
        li.innerHTML = `
          <div class="list-item-content" style="background-color: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="margin-left: 8px; margin-right: 8px;">
              <strong>Paso ${index + 1}:</strong> ${step.text}
            </div>
            <div class="list-item-actions" style="margin-top: 8px; text-align: right;">
              <button class="btn-icon" onclick="editStep(${step.id})">
                <span class="material-icons" style="font-size: 18px;">edit</span>
              </button>
              <button class="btn-icon" onclick="deleteStep(${step.id})">
                <span class="material-icons" style="font-size: 18px;">delete</span>
              </button>
            </div>
          </div>
        `;
        stepsList.appendChild(li);
      });
      
      if (typeof updateSummary === 'function') {
        updateSummary();
      }
    }
    
    function saveStepsToStorage() {
      localStorage.setItem('steps', JSON.stringify(steps));
    }
    
    // Funciones globales para manipular pasos
    window.deleteStep = function(id) {
      steps = steps.filter(item => item.id !== id);
      updateStepsList();
      saveStepsToStorage();
      showToast('Paso eliminado');
    };
    
    window.editStep = function(id) {
      const stepIndex = steps.findIndex(item => item.id === id);
      const step = steps[stepIndex];
      if (step && stepIndex !== -1) {
        // Guardar la posici√≥n del paso que se est√° editando
        editingStepIndex = stepIndex;
        
        // Colocar el texto en el formulario
        document.getElementById('preparation-step').value = step.text;
        
        // Scroll al formulario
        document.getElementById('preparation-step').scrollIntoView({behavior: 'smooth'});
        document.getElementById('preparation-step').focus();
        
        // Cambiar el texto del bot√≥n para indicar que se est√° editando
        const addButton = document.getElementById('add-step');
        const cancelButton = document.getElementById('cancel-edit-step');
        
        if (addButton) {
          addButton.innerHTML = '<span class="material-icons">edit</span> Actualizar Paso';
          addButton.style.backgroundColor = '#FF9800'; // Color naranja para edici√≥n
        }
        
        if (cancelButton) {
          cancelButton.style.display = 'block'; // Mostrar bot√≥n cancelar
        }
        
        showToast('Editando paso ' + (stepIndex + 1), 'warning');
      }
    };
    
    // Funci√≥n para cancelar la edici√≥n
    function cancelEdit() {
      editingStepIndex = -1;
      
      // Limpiar formulario
      document.getElementById('preparation-step').value = '';
      
      // Restaurar el bot√≥n a su estado normal
      const addButton = document.getElementById('add-step');
      const cancelButton = document.getElementById('cancel-edit-step');
      
      if (addButton) {
        addButton.innerHTML = '<span class="material-icons">playlist_add</span> Agregar Paso';
        addButton.style.backgroundColor = ''; // Restaurar color original
      }
      
      if (cancelButton) {
        cancelButton.style.display = 'none'; // Ocultar bot√≥n cancelar
      }
      
      showToast('Edici√≥n cancelada');
    }
    
    // Asignar evento al bot√≥n cancelar
    const cancelEditButton = document.getElementById('cancel-edit-step');
    if (cancelEditButton) {
      cancelEditButton.addEventListener('click', cancelEdit);
    }
    
    // Manejo de fotos con fecha, ubicaci√≥n y numeraci√≥n
    // Funci√≥n para comprimir im√°genes antes de guardarlas
    function compressImage(file, quality = 0.7, maxWidth = 800) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
              height = (maxWidth / width) * height;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Comprimir a formato JPEG con la calidad especificada
            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedDataUrl);
          };
          img.onerror = (error) => reject(error);
        };
        reader.onerror = (error) => reject(error);
      });
    }

    function handleFileSelect(event, containerId) {
      const files = event.target.files;
      const container = document.getElementById(containerId);
      
      // Determinar qu√© categor√≠a de fotos es (ANTES, DURANTE, DESPU√âS)
      let categoryText = '';
      let categoryPrefix = '';
      
      if (containerId === 'before-photos') {
        categoryText = 'ANTES';
        categoryPrefix = 'A';
      } else if (containerId === 'during-photos') {
        categoryText = 'DURANTE';
        categoryPrefix = 'D';
      } else if (containerId === 'after-photos') {
        categoryText = 'DESPU√âS';
        categoryPrefix = 'P';
      }
      
      if (files.length > 0) {
        showToast(`${files.length} foto(s) seleccionada(s) - ${categoryText}`);
      }
      
      // Obtener la fecha y hora actual
      const now = new Date();
      const dateString = now.toLocaleDateString('es-PE');
      const timeString = now.toLocaleTimeString('es-PE');
      const dateTimeString = `${dateString} ${timeString}`;
      
      // Intentar obtener la ubicaci√≥n
      getLocation().then(locationText => {
        // Contar las fotos existentes para la numeraci√≥n
        let existingPhotos = container.querySelectorAll('.photo-item').length;
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const photoNumber = existingPhotos + i + 1;

          compressImage(file).then(compressedSrc => {
            // Crear elemento para la foto con toda la informaci√≥n
            const div = document.createElement('div');
            div.className = 'photo-item';
            
            // Estructura de la foto con metadatos
            div.innerHTML = `
              <div class="photo-number">${categoryPrefix}${photoNumber}</div>
              <button class="photo-delete-btn" onclick="deletePhoto('${containerId}', ${photoNumber}, '${categoryPrefix}')" title="Eliminar foto">
                √ó
              </button>
              <img src="${compressedSrc}" alt="Foto ${categoryText} ${photoNumber}">
              <div class="photo-info">
                <div class="photo-date">${dateTimeString}</div>
                <div class="photo-location">${locationText}</div>
              </div>
            `;
            container.appendChild(div);
            
            // Guardar en localStorage con los metadatos
            const photoData = {
              src: compressedSrc,
              category: categoryText,
              number: photoNumber,
              prefix: categoryPrefix,
              date: dateTimeString,
              location: locationText
            };
            
            // Intentar guardar y solo agregar al DOM si se guarda exitosamente
            if (savePhotoToStorage(containerId, photoData)) {
              container.appendChild(div);
              // Actualizar la vista de resultados cuando se agregue una foto
              updateSummaryPhotos();
            } else {
              // Si no se puede guardar, no agregar al DOM
              console.warn('Foto no agregada al DOM porque no se pudo guardar');
            }
          }).catch(err => {
            console.error('Error al comprimir la imagen:', err);
            showToast('Error al procesar una de las im√°genes', 'error');
          });
        }
      }).catch(err => {
        showToast('No se pudo obtener la ubicaci√≥n, foto sin geolocalizaci√≥n', 'warning');
        
        // Continuar sin ubicaci√≥n
        let existingPhotos = container.querySelectorAll('.photo-item').length;
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const photoNumber = existingPhotos + i + 1;

          compressImage(file).then(compressedSrc => {
            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
              <div class="photo-number">${categoryPrefix}${photoNumber}</div>
              <button class="photo-delete-btn" onclick="deletePhoto('${containerId}', ${photoNumber}, '${categoryPrefix}')" title="Eliminar foto">
                √ó
              </button>
              <img src="${compressedSrc}" alt="Foto ${categoryText} ${photoNumber}">
              <div class="photo-info">
                <div class="photo-date">${dateTimeString}</div>
              </div>
            `;
            container.appendChild(div);
            
            // Guardar en localStorage sin ubicaci√≥n
            const photoData = {
              src: compressedSrc,
              category: categoryText,
              number: photoNumber,
              prefix: categoryPrefix,
              date: dateTimeString,
              location: 'No disponible'
            };
            
            // Intentar guardar y solo agregar al DOM si se guarda exitosamente
            if (savePhotoToStorage(containerId, photoData)) {
              container.appendChild(div);
              // Actualizar la vista de resultados cuando se agregue una foto
              updateSummaryPhotos();
            } else {
              console.warn('Foto no agregada al DOM porque no se pudo guardar');
            }
          }).catch(err => {
            console.error('Error al comprimir la imagen:', err);
            showToast('Error al procesar una de las im√°genes', 'error');
          });
        }
      });
    }
    
    // Funci√≥n para obtener la ubicaci√≥n del usuario
    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject('Geolocalizaci√≥n no soportada en este dispositivo');
          return;
        }
        
        navigator.geolocation.getCurrentPosition(
          position => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            
            // Usar solo coordenadas para evitar problemas CORS
            const locationString = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
            resolve(locationString);
          },
          error => {
            reject('Error al obtener ubicaci√≥n');
          },
          { 
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      });
    }
    
    const photoBefore = document.getElementById('photo-before');
    if (photoBefore) {
      photoBefore.addEventListener('change', function(e) {
        console.log('Evento change en photo-before detectado');
        handleFileSelect(e, 'before-photos');
      });
      console.log('Evento change asignado a photoBefore');
    } else {
      console.error('Elemento photo-before no encontrado');
    }
    
    const photoDuring = document.getElementById('photo-during');
    if (photoDuring) {
      photoDuring.addEventListener('change', function(e) {
        console.log('Evento change en photo-during detectado');
        handleFileSelect(e, 'during-photos');
      });
      console.log('Evento change asignado a photoDuring');
    } else {
      console.error('Elemento photo-during no encontrado');
    }
    
    const photoAfter = document.getElementById('photo-after');
    if (photoAfter) {
      photoAfter.addEventListener('change', function(e) {
        console.log('Evento change en photo-after detectado');
        handleFileSelect(e, 'after-photos');
      });
      console.log('Evento change asignado a photoAfter');
    } else {
      console.error('Elemento photo-after no encontrado');
    }
    
    // Guardar fotos en localStorage con metadatos y manejo de l√≠mites
    function savePhotoToStorage(containerId, photoData) {
      const storageKey = containerId + '-photos';
      let photos = JSON.parse(localStorage.getItem(storageKey) || '[]');
      
      console.log(`Intentando guardar foto en ${containerId}:`, {
        currentPhotos: photos.length,
        photoData: photoData,
        storageKey: storageKey
      });
      
      // Verificar l√≠mite de fotos por categor√≠a (m√°s permisivo)
      const maxPhotosPerCategory = 10; // L√≠mite fijo m√°s alto por categor√≠a
      
      if (photos.length >= maxPhotosPerCategory) {
        console.warn(`L√≠mite alcanzado para ${containerId}: ${photos.length}/${maxPhotosPerCategory}`);
        showToast(`L√≠mite alcanzado para esta categor√≠a: m√°ximo ${maxPhotosPerCategory} fotos`, 'warning');
        return false;
      }
      
      try {
        photos.push(photoData);
        console.log(`Intentando guardar ${photos.length} fotos en ${storageKey}`);
        localStorage.setItem(storageKey, JSON.stringify(photos));
        
        // Verificar que se guard√≥ correctamente
        const savedPhotos = JSON.parse(localStorage.getItem(storageKey) || '[]');
        if (savedPhotos.length === photos.length) {
          console.log(`‚úÖ Foto guardada exitosamente en ${storageKey}. Total: ${photos.length}/${maxPhotosPerCategory}`);
          updatePhotoLimitIndicators(); // Actualizar indicadores despu√©s de guardar
          return true;
        } else {
          console.error(`‚ùå Error al verificar guardado en ${storageKey}. Esperado: ${photos.length}, Actual: ${savedPhotos.length}`);
          return false;
        }
      } catch (e) {
        console.error(`‚ùå Excepci√≥n al guardar en ${storageKey}:`, e);
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage lleno, limpiando fotos antiguas...');
          cleanOldPhotos();
          // Intentar guardar de nuevo despu√©s de limpiar
          try {
            localStorage.setItem(storageKey, JSON.stringify(photos));
            showToast('Foto guardada despu√©s de limpiar espacio', 'warning');
            return true;
          } catch (e2) {
            showToast('Error: No se puede guardar la foto, storage lleno', 'error');
            return false;
          }
        } else {
          console.error('Error al guardar foto:', e);
          showToast('Error al guardar la foto', 'error');
          return false;
        }
      }
    }
    
    // Cargar fotos guardadas con metadatos
    function loadSavedPhotos() {
      const containers = ['before-photos', 'during-photos', 'after-photos'];
      
      containers.forEach(containerId => {
        const storageKey = containerId + '-photos';
        const photos = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const container = document.getElementById(containerId);
        
        // Limpiar el contenedor antes de cargar para evitar duplicados
        if (container) {
          container.innerHTML = '';
        }
        
        photos.forEach((photo, index) => {
          const div = document.createElement('div');
          div.className = 'photo-item';
          
          // Comprobar si es el formato antiguo (string) o el nuevo (objeto)
          if (typeof photo === 'string') {
            // Formato antiguo - solo URL
            div.innerHTML = `<img src="${photo}" alt="Foto">`;
          } else {
            // Formato nuevo con metadatos
            div.innerHTML = `
              <div class="photo-number">${photo.prefix || ''}${photo.number || index+1}</div>
              <button class="photo-delete-btn" onclick="deletePhoto('${containerId}', ${photo.number || index+1}, '${photo.prefix || ''}')" title="Eliminar foto">
                √ó
              </button>
              <img src="${photo.src}" alt="Foto ${photo.category || ''} ${photo.number || index+1}">
              <div class="photo-info">
                <div class="photo-date">${photo.date || 'Sin fecha'}</div>
                ${photo.location && photo.location !== 'No disponible' ? `<div class="photo-location">${photo.location}</div>` : ''}
              </div>
            `;
          }
          
          container.appendChild(div);
        });
      });
    }
    
    // Ejecutar al cargar
    loadSavedPhotos();
    
    // Funci√≥n para eliminar una foto individual
    function deletePhoto(containerId, photoNumber, categoryPrefix) {
      if (confirm('¬øEst√°s seguro de que quieres eliminar esta foto?')) {
        console.log(`Eliminando foto ${categoryPrefix}${photoNumber} del contenedor ${containerId}`);
        
        // Eliminar del localStorage
        const storageKey = containerId + '-photos';
        let photos = JSON.parse(localStorage.getItem(storageKey) || '[]');
        
        // Encontrar y eliminar la foto del array
        const photoIndex = photos.findIndex(photo => 
          (photo.number && photo.number === photoNumber) || 
          (photo.prefix === categoryPrefix && photo.number === photoNumber)
        );
        
        if (photoIndex !== -1) {
          photos.splice(photoIndex, 1);
          localStorage.setItem(storageKey, JSON.stringify(photos));
          console.log(`Foto eliminada del localStorage. Fotos restantes: ${photos.length}`);
        }
        
        // Eliminar del DOM
        const container = document.getElementById(containerId);
        const photoItems = container.querySelectorAll('.photo-item');
        
        photoItems.forEach(item => {
          const numberElement = item.querySelector('.photo-number');
          if (numberElement && numberElement.textContent === `${categoryPrefix}${photoNumber}`) {
            item.remove();
            console.log(`Foto ${categoryPrefix}${photoNumber} eliminada del DOM`);
          }
        });
        
        // Actualizar la vista de resumen
        updateSummaryPhotos();
        
        // Mostrar confirmaci√≥n
        showToast(`Foto ${categoryPrefix}${photoNumber} eliminada exitosamente`, 'success');
      }
    }
    
    // Hacer la funci√≥n disponible globalmente
    window.deletePhoto = deletePhoto;
    
    // Actualizar tambi√©n las fotos en la secci√≥n de resumen
    setTimeout(() => {
      updateSummaryPhotos();
      console.log('Fotos de resumen actualizadas despu√©s de cargar fotos principales');
    }, 300);
    
    // Verificar si se cargaron correctamente las fotos
    function verificarCargaFotos() {
      const containers = ['before-photos', 'during-photos', 'after-photos'];
      containers.forEach(containerId => {
        const storageKey = containerId + '-photos';
        const photos = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const elementosDOM = document.getElementById(containerId).querySelectorAll('.photo-item').length;
        console.log(`${containerId}: ${photos.length} fotos en localStorage, ${elementosDOM} elementos en DOM`);
        if (photos.length > 0 && elementosDOM !== photos.length) {
          console.warn(`Discrepancia en ${containerId}: ${photos.length} en localStorage vs ${elementosDOM} en DOM`);
        }
      });
    }
    setTimeout(verificarCargaFotos, 1000);
    
    // Mostrar las fotos por categor√≠as en la secci√≥n de resultados
    function updateSummaryPhotos() {
      // Corregir las claves de almacenamiento para obtener las fotos correctamente
      const containers = [
        { id: 'summary-before-photos', storageKey: 'before-photos-photos' },
        { id: 'summary-during-photos', storageKey: 'during-photos-photos' },
        { id: 'summary-after-photos', storageKey: 'after-photos-photos' }
      ];
      
      containers.forEach(container => {
        const containerElement = document.getElementById(container.id);
        if (!containerElement) return;
        
        containerElement.innerHTML = '';
        let photosData = localStorage.getItem(container.storageKey);
        let photos = [];
        
        try {
          // Intentar parsear las fotos - podr√≠an estar en diferentes formatos
          if (photosData) {
            photos = JSON.parse(photosData);
            console.log(`Fotos cargadas para ${container.id}:`, photos.length);
          }
        } catch (error) {
          console.error(`Error al parsear fotos para ${container.id}:`, error);
          photos = [];
        }
        
        if (!Array.isArray(photos) || photos.length === 0) {
          containerElement.innerHTML = '<p style="text-align:center; color:var(--text-secondary); padding:16px;">No hay fotos a√∫n</p>';
          return;
        }
        
        photos.forEach(photo => {
          const photoElement = document.createElement('div');
          photoElement.className = 'photo-item';
          photoElement.style.overflow = 'hidden';
          photoElement.style.borderRadius = '8px';
          photoElement.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
          photoElement.style.position = 'relative';
          photoElement.style.display = 'flex';
          photoElement.style.flexDirection = 'column';
          
          // Crear contenedor para la imagen
          const imgContainer = document.createElement('div');
          imgContainer.style.height = '130px';
          imgContainer.style.overflow = 'hidden';
          
          const img = document.createElement('img');
          // Usar la propiedad correcta seg√∫n el formato de la foto guardada
          img.src = photo.src || photo.dataUrl || photo;
          img.alt = `Foto ${photo.date || ''}`;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          
          // Manejar errores de carga de imagen
          img.onerror = function() {
            this.style.display = 'none';
            const errorMsg = document.createElement('div');
            errorMsg.textContent = 'Error al cargar imagen';
            errorMsg.style.padding = '20px';
            errorMsg.style.textAlign = 'center';
            errorMsg.style.color = '#666';
            imgContainer.appendChild(errorMsg);
          };
          
          // Debug: registrar la carga de fotos
          console.log('Cargando foto en resultado:', {
            src: img.src,
            photoData: photo
          });
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.transition = 'transform 0.3s ease';
          
          // Agregar efecto hover
          img.onmouseover = () => { img.style.transform = 'scale(1.05)'; };
          img.onmouseout = () => { img.style.transform = 'scale(1)'; };
          
          // Agregar n√∫mero o prefijo de la foto si existe
          if (photo.number || photo.prefix) {
            const photoNumber = document.createElement('div');
            photoNumber.className = 'photo-number';
            photoNumber.textContent = photo.prefix ? `${photo.prefix}-${photo.number || ''}` : photo.number || '';
            photoNumber.style.position = 'absolute';
            photoNumber.style.top = '8px';
            photoNumber.style.left = '8px';
            photoNumber.style.backgroundColor = 'var(--primary-color)';
            photoNumber.style.color = 'white';
            photoNumber.style.fontWeight = '600';
            photoNumber.style.padding = '4px 8px';
            photoNumber.style.borderRadius = '4px';
            photoNumber.style.fontSize = '12px';
            photoNumber.style.zIndex = '1';
            photoElement.appendChild(photoNumber);
            
            // Agregar bot√≥n de eliminar en la vista de resumen
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'photo-delete-btn';
            deleteBtn.innerHTML = '√ó';
            deleteBtn.title = 'Eliminar foto';
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '8px';
            deleteBtn.style.right = '8px';
            deleteBtn.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
            deleteBtn.style.color = 'white';
            deleteBtn.style.border = 'none';
            deleteBtn.style.borderRadius = '50%';
            deleteBtn.style.width = '24px';
            deleteBtn.style.height = '24px';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.display = 'flex';
            deleteBtn.style.alignItems = 'center';
            deleteBtn.style.justifyContent = 'center';
            deleteBtn.style.fontSize = '12px';
            deleteBtn.style.fontWeight = 'bold';
            deleteBtn.style.transition = 'all 0.3s ease';
            deleteBtn.style.zIndex = '10';
            deleteBtn.style.opacity = '0';
            deleteBtn.style.transform = 'scale(0.8)';
            
            // Determinar containerId basado en el storageKey
            let containerId = '';
            if (container.storageKey === 'before-photos-photos') containerId = 'before-photos';
            else if (container.storageKey === 'during-photos-photos') containerId = 'during-photos';
            else if (container.storageKey === 'after-photos-photos') containerId = 'after-photos';
            
            deleteBtn.addEventListener('click', () => {
              window.deletePhoto(containerId, photo.number, photo.prefix || '');
            });
            
            // Efectos hover para mostrar el bot√≥n
            photoElement.addEventListener('mouseenter', () => {
              deleteBtn.style.opacity = '1';
              deleteBtn.style.transform = 'scale(1)';
            });
            
            photoElement.addEventListener('mouseleave', () => {
              deleteBtn.style.opacity = '0';
              deleteBtn.style.transform = 'scale(0.8)';
            });
            
            deleteBtn.addEventListener('mouseenter', () => {
              deleteBtn.style.backgroundColor = 'rgba(255, 0, 0, 1)';
              deleteBtn.style.transform = 'scale(1.1)';
            });
            
            deleteBtn.addEventListener('mouseleave', () => {
              deleteBtn.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
              deleteBtn.style.transform = 'scale(1)';
            });
            
            photoElement.appendChild(deleteBtn);
          }
          
          // Agregar metadatos (fecha y ubicaci√≥n)
          const metadataContainer = document.createElement('div');
          metadataContainer.className = 'photo-metadata';
          metadataContainer.style.padding = '8px';
          metadataContainer.style.backgroundColor = '#f5f5f5';
          metadataContainer.style.borderTop = '1px solid #e0e0e0';
          metadataContainer.style.fontSize = '11px';
          
          // Fecha
          const dateElement = document.createElement('div');
          dateElement.className = 'photo-date';
          dateElement.textContent = photo.date || 'Sin fecha';
          dateElement.style.color = '#616161';
          dateElement.style.marginBottom = '2px';
          
          // Ubicaci√≥n
          const locationElement = document.createElement('div');
          locationElement.className = 'photo-location';
          locationElement.textContent = photo.location || 'Sin ubicaci√≥n';
          locationElement.style.color = '#757575';
          locationElement.style.overflow = 'hidden';
          locationElement.style.textOverflow = 'ellipsis';
          locationElement.style.whiteSpace = 'nowrap';
          
          metadataContainer.appendChild(dateElement);
          metadataContainer.appendChild(locationElement);
          
          imgContainer.appendChild(img);
          photoElement.appendChild(imgContainer);
          photoElement.appendChild(metadataContainer);
          containerElement.appendChild(photoElement);
        });
      });
    }
    
    // Las fotos ahora se muestran todas simult√°neamente en secciones separadas
    
    // Guardar descripciones
    const saveButtons = ['save-before', 'save-during', 'save-after'];
    
    saveButtons.forEach(buttonId => {
      document.getElementById(buttonId).addEventListener('click', function() {
        const descriptionId = buttonId.replace('save-', 'description-');
        const description = document.getElementById(descriptionId).value;
        localStorage.setItem(descriptionId, description);
        showToast('Descripci√≥n guardada');
      });
    });
    
    // Cargar descripciones guardadas
    function loadSavedDescriptions() {
      const descriptionIds = ['description-before', 'description-during', 'description-after'];
      
      descriptionIds.forEach(id => {
        const description = localStorage.getItem(id);
        if (description) {
          document.getElementById(id).value = description;
        }
      });
    }
    
    // Ejecutar al cargar
    loadSavedDescriptions();
    
    // T√≠tulo de la receta
    const recipeTitle = document.getElementById('recipe-title');
    recipeTitle.value = localStorage.getItem('recipe-title') || '';
    
    recipeTitle.addEventListener('input', () => {
      localStorage.setItem('recipe-title', recipeTitle.value);
      updateSummary();
    });
    
    // Actualizar resumen
    function updateSummary() {
      try {
        // Verificar que los elementos existan antes de actualizarlos
        const summaryTitle = document.getElementById('summary-title');
        if (summaryTitle) {
          summaryTitle.textContent = document.getElementById('recipe-title').value || '-';
        }
        
        // Actualizar el nombre del chef
        const summaryChef = document.getElementById('summary-chef');
        if (summaryChef) {
          const chefName = document.getElementById('chef-name').value || '-';
          summaryChef.textContent = chefName;
          localStorage.setItem('chef-name', chefName);
        }
        
        // Mostrar la fecha actual
        const summaryDate = document.getElementById('summary-date');
        if (summaryDate) {
          const now = new Date();
          const dateFormatted = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
          summaryDate.textContent = dateFormatted;
        }
        
        const summaryIngredients = document.getElementById('summary-ingredients');
        if (summaryIngredients && typeof ingredients !== 'undefined') {
          summaryIngredients.textContent = ingredients.length;
        }
        
        // Asegurarnos de que steps est√© definido
        const stepsArray = typeof steps !== 'undefined' ? steps : [];
        
        // Verificar que steps est√© definido antes de acceder a su longitud
        const summarySteps = document.getElementById('summary-steps');
        if (summarySteps) {
          summarySteps.textContent = stepsArray.length;
        }
        
        // Contar total de fotos
        const summaryPhotos = document.getElementById('summary-photos');
        if (summaryPhotos) {
          try {
            const beforePhotos = JSON.parse(localStorage.getItem('before-photos-photos') || '[]').length;
            const duringPhotos = JSON.parse(localStorage.getItem('during-photos-photos') || '[]').length;
            const afterPhotos = JSON.parse(localStorage.getItem('after-photos-photos') || '[]').length;
            const totalPhotos = beforePhotos + duringPhotos + afterPhotos;
            summaryPhotos.textContent = totalPhotos;
            console.log(`Total fotos: ${totalPhotos} (ANTES: ${beforePhotos}, DURANTE: ${duringPhotos}, DESPU√âS: ${afterPhotos})`);
          } catch (error) {
            console.error('Error al contar fotos:', error);
            summaryPhotos.textContent = '0';
          }
        }
        
        // Contar anotaciones de bit√°cora
        const summaryLogbook = document.getElementById('summary-logbook');
        if (summaryLogbook) {
          try {
            const logbookEntries = JSON.parse(localStorage.getItem('logbook-entries') || '[]').length;
            summaryLogbook.textContent = logbookEntries;
            console.log(`Total anotaciones bit√°cora: ${logbookEntries}`);
          } catch (error) {
            console.error('Error al contar anotaciones de bit√°cora:', error);
            summaryLogbook.textContent = '0';
          }
        }
        
        // Verificar que ingredients est√© definido antes de calcular el costo total
        let totalCost = 0;
        if (typeof ingredients !== 'undefined') {
          totalCost = ingredients.reduce((sum, item) => sum + item.price, 0);
        }
        
        const summaryCost = document.getElementById('summary-cost');
        if (summaryCost) {
          summaryCost.textContent = `S/${totalCost.toFixed(2)}`;
        }
        
        const suggestedPrice = totalCost * 1.3;
        const suggestedPriceElement = document.getElementById('suggested-price');
        if (suggestedPriceElement) {
          suggestedPriceElement.textContent = `S/${suggestedPrice.toFixed(2)}`;
        }
        
        // Actualizar tambi√©n los elementos de la secci√≥n de punto de equilibrio
        const costoIngredientesDisplay = document.getElementById('costo-ingredientes-display');
        if (costoIngredientesDisplay) {
          costoIngredientesDisplay.textContent = `S/${totalCost.toFixed(2)}`;
        }
      } catch (error) {
        console.error('Error en updateSummary:', error);
      }
    }
    
    // ... (c√≥digo anterior) ...

    // Funci√≥n para actualizar costos en tiempo real
    function updateBreakevenCosts() {
      try {
        const ingredientes = JSON.parse(localStorage.getItem('ingredients') || '[]');
        const costoTotalIngredientes = ingredientes.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        
        const costoIngredientesDisplay = document.getElementById('costo-ingredientes-display');
        if (costoIngredientesDisplay) {
          costoIngredientesDisplay.textContent = `S/${costoTotalIngredientes.toFixed(2)}`;
        }
        
        // Calcular costo por unidad basado en el RENDIMIENTO de los ingredientes
        const rendimientoIngredientes = parseFloat(document.getElementById('rendimiento-ingredientes')?.value) || 0;
        const costoUnitarioIngredientes = rendimientoIngredientes > 0 ? (costoTotalIngredientes / rendimientoIngredientes) : 0;
        
        const costoUnitarioDisplay = document.getElementById('costo-unitario-ingredientes');
        if (costoUnitarioDisplay) {
          if (rendimientoIngredientes > 0) {
            costoUnitarioDisplay.textContent = `S/${costoUnitarioIngredientes.toFixed(2)}`;
            costoUnitarioDisplay.parentElement.style.opacity = '1';
          } else {
            costoUnitarioDisplay.textContent = 'Especifica rendimiento';
            costoUnitarioDisplay.parentElement.style.opacity = '0.6';
          }
        }
        
        // AUTO-LLENAR cantidad a producir con el rendimiento de ingredientes
        const cantidadProducidaInput = document.getElementById('cantidad-producida');
        if (cantidadProducidaInput && rendimientoIngredientes > 0) {
          cantidadProducidaInput.value = rendimientoIngredientes;
        } else if (cantidadProducidaInput) {
          cantidadProducidaInput.value = '';
        }
        
        // Analizar el precio de venta si est√° ingresado
        analizarPrecioVenta();
        
        // Limpiar resultados de punto de equilibrio (se calcular√° con el bot√≥n)
        document.getElementById('punto-equilibrio-unidades').textContent = '0';
        document.getElementById('punto-equilibrio-ingresos').textContent = 'S/0.00';
      } catch (error) {
        console.error('Error al actualizar costos de punto de equilibrio:', error);
      }
    }
    
    // Funci√≥n para analizar si el precio genera p√©rdida o ganancia (mejorada para casos educativos)
    function analizarPrecioVenta() {
      try {
        const precioVenta = parseFloat(document.getElementById('precio-venta')?.value) || 0;
        const rendimientoIngredientes = parseFloat(document.getElementById('rendimiento-ingredientes')?.value) || 0;
        const costoUnitarioExtra = parseFloat(document.getElementById('costo-unitario-extra')?.value) || 0;
        
        const ingredientes = JSON.parse(localStorage.getItem('ingredients') || '[]');
        const costoTotalIngredientes = ingredientes.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        
        const analisisDiv = document.getElementById('analisis-precio');
        const resultadoSpan = document.getElementById('resultado-analisis');
        
        if (rendimientoIngredientes <= 0) {
          if (analisisDiv) {
            analisisDiv.style.display = 'block';
            analisisDiv.style.backgroundColor = '#FFF3E0';
            analisisDiv.style.borderLeft = '4px solid #FF9800';
            resultadoSpan.style.color = '#E65100';
            resultadoSpan.innerHTML = '‚ö†Ô∏è Debes ingresar la cantidad que produces con tus ingredientes';
          }
          return;
        }
        
        const costoUnitarioIngredientes = costoTotalIngredientes / rendimientoIngredientes;
        const costoTotalUnitario = costoUnitarioIngredientes + costoUnitarioExtra;
        
        if (analisisDiv && resultadoSpan) {
          analisisDiv.style.display = 'block';
          
          // Caso especial: Costos cero (ingredientes de la naturaleza)
          if (costoTotalUnitario === 0) {
            if (precioVenta > 0) {
              analisisDiv.style.backgroundColor = '#E8F5E8';
              analisisDiv.style.borderLeft = '4px solid #4CAF50';
              resultadoSpan.style.color = '#2E7D32';
              resultadoSpan.innerHTML = `üåü EXCELENTE: S/${precioVenta.toFixed(2)} de ganancia pura por unidad.<br>
                <small>üí° <strong>An√°lisis:</strong> Al no tener costos de ingredientes (productos naturales), 
                cualquier precio que pongas ser√° ganancia. ¬°Aprovecha esta ventaja competitiva!</small>`;
            } else {
              analisisDiv.style.backgroundColor = '#FFF3E0';
              analisisDiv.style.borderLeft = '4px solid #FF9800';
              resultadoSpan.style.color = '#E65100';
              resultadoSpan.innerHTML = 'üí≠ Ingresa un precio de venta para ver tu ganancia potencial';
            }
            return;
          }
          
          // Casos normales con costos
          if (precioVenta > 0) {
            if (precioVenta > costoTotalUnitario) {
              const ganancia = precioVenta - costoTotalUnitario;
              const porcentajeGanancia = ((ganancia / costoTotalUnitario) * 100).toFixed(1);
              const margenGanancia = ((ganancia / precioVenta) * 100).toFixed(1);
              
              analisisDiv.style.backgroundColor = '#E8F5E8';
              analisisDiv.style.borderLeft = '4px solid #4CAF50';
              resultadoSpan.style.color = '#2E7D32';
              
              let mensaje = `‚úÖ <strong>GANANCIA:</strong> S/${ganancia.toFixed(2)} por unidad<br>`;
              mensaje += `üìä <strong>An√°lisis:</strong> ${margenGanancia}% de margen de ganancia`;
              
              if (parseFloat(porcentajeGanancia) > 100) {
                mensaje += `<br>üöÄ <strong>Excelente:</strong> Duplicas tu inversi√≥n con m√°s del 100% de ganancia`;
              } else if (parseFloat(porcentajeGanancia) > 50) {
                mensaje += `<br>üëç <strong>Muy bueno:</strong> Ganancia saludable del ${porcentajeGanancia}%`;
              } else if (parseFloat(porcentajeGanancia) > 20) {
                mensaje += `<br>‚úì <strong>Aceptable:</strong> Ganancia moderada del ${porcentajeGanancia}%`;
              } else {
                mensaje += `<br>‚ö†Ô∏è <strong>Cuidado:</strong> Ganancia baja (${porcentajeGanancia}%). Considera aumentar el precio`;
              }
              
              resultadoSpan.innerHTML = mensaje;
              
            } else if (precioVenta < costoTotalUnitario) {
              const perdida = costoTotalUnitario - precioVenta;
              const porcentajePerdida = ((perdida / costoTotalUnitario) * 100).toFixed(1);
              
              analisisDiv.style.backgroundColor = '#FFEBEE';
              analisisDiv.style.borderLeft = '4px solid #F44336';
              resultadoSpan.style.color = '#C62828';
              
              let mensaje = `‚ùå <strong>P√âRDIDA:</strong> S/${perdida.toFixed(2)} por unidad<br>`;
              mensaje += `üìâ <strong>An√°lisis:</strong> Pierdes ${porcentajePerdida}% de tu inversi√≥n<br>`;
              mensaje += `üí° <strong>Recomendaci√≥n:</strong> Aumenta el precio a m√≠nimo S/${costoTotalUnitario.toFixed(2)} para no perder`;
              
              resultadoSpan.innerHTML = mensaje;
              
            } else {
              analisisDiv.style.backgroundColor = '#FFF3E0';
              analisisDiv.style.borderLeft = '4px solid #FF9800';
              resultadoSpan.style.color = '#E65100';
              resultadoSpan.innerHTML = `‚ö†Ô∏è <strong>PUNTO MUERTO:</strong> Sin ganancia ni p√©rdida<br>
                <small>üí≠ <strong>Consejo:</strong> Aumenta el precio aunque sea S/0.10 para obtener ganancia</small>`;
            }
          } else {
            analisisDiv.style.backgroundColor = '#FFF3E0';
            analisisDiv.style.borderLeft = '4px solid #FF9800';
            resultadoSpan.style.color = '#E65100';
            resultadoSpan.innerHTML = `üí≠ Ingresa un precio de venta para analizar si tendr√°s ganancia o p√©rdida<br>
              <small>üí° <strong>Costo por unidad:</strong> S/${costoTotalUnitario.toFixed(2)}</small>`;
          }
        }
      } catch (error) {
        console.error('Error al analizar precio de venta:', error);
      }
    }
    
    // Llamada inicial para actualizar el resumen al cargar la p√°gina
    updateSummary();
    
    // Actualizar costos de punto de equilibrio al cambiar de pesta√±a
    window.updateBreakevenCosts = updateBreakevenCosts;

    // --- FUNCIONALIDAD DE IMPRESI√ìN ---
    
    // Funci√≥n para actualizar la vista de impresi√≥n cuando se cambia a esa pesta√±a
    function updatePrintView() {
      console.log('Actualizando vista de impresi√≥n autom√°ticamente...');
      // Simplemente llamamos a preparePrintView que ya hace todo el trabajo
      preparePrintView();
      // Mostrar mensaje sutil de que se actualiz√≥
      showToast('Vista previa actualizada autom√°ticamente', 'success');
    }
    
    document.getElementById('prepare-print-btn').addEventListener('click', preparePrintView);
    document.getElementById('print-btn').addEventListener('click', () => {
        window.print();
    });

    function preparePrintView() {
    const printContent = document.getElementById('print-content');
    const recipeTitle = localStorage.getItem('recipe-title') || 'Mi Receta';
    const chefName = localStorage.getItem('chef-name') || 'Chef';
    // Usar el mismo campo de chef para mostrar como "Realizado por"
    const studentName = chefName;
    const reportLogo = localStorage.getItem('report-logo'); // Obtener logo guardado
    const ingredientes = JSON.parse(localStorage.getItem('ingredients')) || [];
    const pasos = JSON.parse(localStorage.getItem('steps')) || [];
    const fotosAntes = JSON.parse(localStorage.getItem('before-photos-photos')) || [];
    const fotosDurante = JSON.parse(localStorage.getItem('during-photos-photos')) || [];
    const fotosDespues = JSON.parse(localStorage.getItem('after-photos-photos')) || [];
    const bitacoraEntries = JSON.parse(localStorage.getItem('logbook-entries')) || [];

    // Informaci√≥n del sistema de fotos
    const isOnlineStatus = isOnline();
    const maxPhotos = getMaxPhotos();
    const totalFotos = fotosAntes.length + fotosDurante.length + fotosDespues.length;

    let costoTotal = 0;
    if (ingredientes.length > 0) {
      costoTotal = ingredientes.reduce((sum, item) => sum + (item.price || 0), 0);
    }
    
    // Obtener datos del punto de equilibrio guardados
    const puntoEquilibrioUnidades = localStorage.getItem('puntoEquilibrioUnidades') || '0';
    const puntoEquilibrioIngresos = localStorage.getItem('puntoEquilibrioIngresos') || '0.00';
    const costosFijos = localStorage.getItem('costosFijos') || '0';
    const precioVenta = localStorage.getItem('precioVenta') || (costoTotal * 1.3).toFixed(2);

    // Crear encabezado con logo si existe
    const logoSection = reportLogo ? `
      <div style="text-align: center; margin-bottom: 20px;">
        <img src="${reportLogo}" alt="Logo" style="max-height: 80px; max-width: 200px; object-fit: contain;">
      </div>
    ` : '';

    let html = `
            ${logoSection}
            <h1 class="print-title">${recipeTitle}</h1>
            ${studentName ? `<p class="meta-info"><strong>Realizado por:</strong> ${studentName}</p>` : ''}
            <p class="meta-info">Creado el: ${new Date().toLocaleDateString('es-PE')}</p>
            
            <div class="print-section">
                <h2>Ingredientes</h2>
                <div class="print-grid">
                    ${ingredientes.map(ing => `
                        <div class="print-card">
                            <strong>${ing.name}</strong> - ${ing.quantity} ${ing.unit}<br>
                            <small>Costo: S/${(ing.price || 0).toFixed(2)}</small>
                        </div>
                    `).join('') || '<p>No hay ingredientes.</p>'}
                </div>
            </div>


      <div class="print-section">
        <h2>Pasos de Preparaci√≥n</h2>
        <ol>
          ${pasos.map(paso => `<li>${paso.text}</li>`).join('') || '<li>No hay pasos.</li>'}
        </ol>
        <div id="dop-diagram-print" style="margin-top:32px; text-align:center;">
          ${pasos.length > 0 ? generarDOPSVG(pasos) : '<p style="color:#888;">No hay pasos para mostrar el diagrama.</p>'}
        </div>
      </div>

            <div class="print-section photo-section">
                <h2>Fotos del Proceso</h2>
                <h3>Antes</h3>
                <div class="photo-grid">
                    ${fotosAntes.map((foto, index) => `
                        <div class="photo-item">
                            <img src="${foto.src}" alt="Foto Antes ${index + 1}">
                            <p>${foto.date || ''}</p>
                        </div>
                    `).join('') || '<p>No hay fotos.</p>'}
                </div>
                <h3>Durante</h3>
                <div class="photo-grid">
                    ${fotosDurante.map((foto, index) => `
                        <div class="photo-item">
                            <img src="${foto.src}" alt="Foto Durante ${index + 1}">
                            <p>${foto.date || ''}</p>
                        </div>
                    `).join('') || '<p>No hay fotos.</p>'}
                </div>
                <h3>Despu√©s</h3>
                <div class="photo-grid">
                    ${fotosDespues.map((foto, index) => `
                        <div class="photo-item">
                            <img src="${foto.src}" alt="Foto Despu√©s ${index + 1}">
                            <p>${foto.date || ''}</p>
                        </div>
                    `).join('') || '<p>No hay fotos.</p>'}
                </div>
            </div>

            <div class="print-section">
                <h2>Bit√°cora de Trabajo</h2>
                ${bitacoraEntries.length > 0 ? bitacoraEntries.map(entry => `
                    <div class="logbook-entry">
                        <p><strong>Fecha:</strong> ${new Date(entry.date).toLocaleDateString('es-PE')}</p>
                        <p><strong>T√≠tulo:</strong> ${entry.title}</p>
                        <p><strong>Categor√≠a:</strong> ${entry.category}</p>
                        <p><strong>Descripci√≥n:</strong> ${entry.text}</p>
                        ${entry.lastModified ? '<p><small style="color: #FF9800;"><strong>Nota:</strong> Esta anotaci√≥n fue editada</small></p>' : ''}
                    </div>
                `).join('') : '<p>No hay anotaciones en la bit√°cora.</p>'}
            </div>
            
            <div class="print-section">
                <h2>Informaci√≥n del Sistema</h2>
                <div class="print-grid">
                    <div class="print-card">
                        <strong>Estado de Conexi√≥n:</strong><br>
                        üì° ${isOnlineStatus ? 'Online' : 'Offline'}<br>
                        <small>M√°ximo fotos permitidas: ${maxPhotos}</small>
                    </div>
                    <div class="print-card">
                        <strong>Fotos Almacenadas:</strong><br>
                        üì∏ ${totalFotos} de ${maxPhotos * 3} m√°ximo<br>
                        <small>ANTES: ${fotosAntes.length}, DURANTE: ${fotosDurante.length}, DESPU√âS: ${fotosDespues.length}</small>
                    </div>
                    <div class="print-card">
                        <strong>Estad√≠sticas:</strong><br>
                        ü•ò ${ingredientes.length} ingredientes<br>
                        üìù ${pasos.length} pasos<br>
                        üìî ${bitacoraEntries.length} anotaciones
                    </div>
                </div>
            </div>

            <div class="print-section">
                <h2>An√°lisis de Costos y Punto de Equilibrio</h2>
                <div class="print-grid">
                    <div class="print-card">
                        <strong>Costos:</strong><br>
                        Ingredientes: S/${costoTotal.toFixed(2)}<br>
                        Costos Fijos: S/${costosFijos}<br>
                        <small>Precio sugerido: S/${precioVenta}</small>
                    </div>
                    <div class="print-card">
                        <strong>Punto de Equilibrio:</strong><br>
                        üéØ ${puntoEquilibrioUnidades} unidades<br>
                        üí∞ S/${puntoEquilibrioIngresos}<br>
                        <small>Para no tener p√©rdidas</small>
                    </div>
                </div>
                <div id="breakeven-chart-print" style="margin-top:16px; text-align:center;">
                  <!-- El gr√°fico SVG se copiar√° aqu√≠ -->
                </div>
                <div style="margin-top:32px; text-align:center;">
                  <h3 style="color:#1976d2; font-size:18px; margin-bottom:8px;">Gr√°fica para dibujar el Punto de Equilibrio</h3>
                  <div style="overflow-x:auto; display:inline-block; max-width:100%;">
                  <svg width="700" height="400" viewBox="0 0 700 400" style="background:#fff; border:1px solid #bbb; border-radius:8px; max-width:100%; height:auto;">
                    <!-- L√≠neas de referencia horizontales -->
                    <g stroke="#eee" stroke-width="1">
                      <line x1="100" y1="350" x2="650" y2="350" />
                      <line x1="100" y1="290" x2="650" y2="290" />
                      <line x1="100" y1="230" x2="650" y2="230" />
                      <line x1="100" y1="170" x2="650" y2="170" />
                      <line x1="100" y1="110" x2="650" y2="110" />
                    </g>
                    <!-- Eje X -->
                    <line x1="100" y1="350" x2="680" y2="350" stroke="#222" stroke-width="2" marker-end="url(#arrowhead)" />
                    <!-- Eje Y -->
                    <line x1="120" y1="370" x2="120" y2="50" stroke="#222" stroke-width="2" marker-end="url(#arrowhead)" />
                    <!-- Etiquetas de ejes -->
                    <text x="670" y="370" font-size="18" fill="#222">Unidades (x)</text>
                    <text x="110" y="70" font-size="18" fill="#222">Monto (S/)</text>
                    <!-- Leyenda -->
                    <rect x="200" y="370" width="30" height="8" fill="none" stroke="#FFA000" stroke-width="4" stroke-dasharray="8,4"/>
                    <text x="240" y="380" font-size="16" fill="#888">Costos Fijos</text>
                    <rect x="350" y="370" width="30" height="8" fill="none" stroke="#E53935" stroke-width="4"/>
                    <text x="390" y="380" font-size="16" fill="#888">Costos Totales</text>
                    <rect x="500" y="370" width="30" height="8" fill="none" stroke="#43A047" stroke-width="4"/>
                    <text x="540" y="380" font-size="16" fill="#888">Ingresos</text>
                    <!-- Definir flecha -->
                    <defs>
                      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#222"/>
                      </marker>
                    </defs>
                  </svg>
                  <div style="color:#888; font-size:13px; margin-top:4px;">Dibuja aqu√≠ el punto de equilibrio y las l√≠neas de costos e ingresos seg√∫n tus datos</div>
                </div>
            </div>
        `;

        printContent.innerHTML = html;
        
        // Copiar el gr√°fico SVG del resultado a la vista de impresi√≥n
        const chartContainer = document.getElementById('breakeven-chart-container');
        const printChartContainer = document.getElementById('breakeven-chart-print');
        
        if (chartContainer && printChartContainer) {
          const svgChart = chartContainer.querySelector('svg');
          if (svgChart) {
            printChartContainer.innerHTML = `
              <h3 style="color:#1976d2; margin-bottom:8px;">Gr√°fico de Punto de Equilibrio</h3>
              ${svgChart.outerHTML}
            `;
          } else {
            printChartContainer.innerHTML = `
              <p style="color:#666; font-style:italic;">
                Gr√°fico no disponible. Genera el punto de equilibrio en la secci√≥n "Resultado".
              </p>
            `;
          }
        }
        
    // --- DOP SVG para impresi√≥n ---
    function generarDOPSVG(pasos) {
      const circleRadius = 30;
      const stepGap = 80;
      const width = Math.max(360, pasos.length * (circleRadius * 2 + stepGap));
      const height = 120;
      let svg = `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;
      pasos.forEach((paso, i) => {
        const cx = circleRadius + i * (circleRadius * 2 + stepGap);
        const cy = height / 2;
        // Flecha al siguiente paso
        if (i < pasos.length - 1) {
          const nextCx = circleRadius + (i + 1) * (circleRadius * 2 + stepGap);
          svg += `<line x1="${cx + circleRadius}" y1="${cy}" x2="${nextCx - circleRadius}" y2="${cy}" stroke="#1976d2" stroke-width="3" marker-end="url(#arrowhead)"/>`;
        }
        // C√≠rculo del paso
        svg += `<circle cx="${cx}" cy="${cy}" r="${circleRadius}" fill="#fff" stroke="#1976d2" stroke-width="3"/>`;
        // N√∫mero de paso
        svg += `<text x="${cx}" y="${cy - 6}" text-anchor="middle" font-size="20" font-weight="bold" fill="#1976d2">${i + 1}</text>`;
        // Texto del paso (m√°x 32 caracteres)
        let texto = paso.text.length > 32 ? paso.text.slice(0, 29) + '‚Ä¶' : paso.text;
        svg += `<text x="${cx}" y="${cy + 22}" text-anchor="middle" font-size="12" fill="#333">${texto.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</text>`;
      });
      // Definir la flecha
      svg += `<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#1976d2"/></marker></defs>`;
      svg += `</svg>`;
      return svg;
    }
        showToast('Vista previa actualizada.');
    }
    // --- FIN FUNCIONALIDAD DE IMPRESI√ìN ---

    // Funci√≥n para mostrar notificaciones (toasts)
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.position = 'fixed';
      toast.style.bottom = '80px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.padding = '12px 20px';
      toast.style.borderRadius = 'var(--border-radius)';
      toast.style.color = 'white';
      toast.style.zIndex = '1000';
      toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
      
      if (type === 'error') {
        toast.style.backgroundColor = '#D32F2F';
      } else if (type === 'warning') {
        toast.style.backgroundColor = '#FFA000';
      } else {
        toast.style.backgroundColor = '#388E3C';
      }
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Cargar nombre del chef
    const chefNameInput = document.getElementById('chef-name');
    if (chefNameInput) {
        chefNameInput.value = localStorage.getItem('chef-name') || '';
        chefNameInput.addEventListener('input', (e) => {
            localStorage.setItem('chef-name', e.target.value);
            updateSummary();
        });
    }

    // --- BIT√ÅCORA DE TRABAJO ---
    // Variables ya inicializadas al principio
    
    // Las anotaciones ya fueron cargadas al inicio
    if (logbookEntries.length > 0) {
      console.log('Cargando anotaciones de bit√°cora al inicio:', logbookEntries.length);
      updateLogbookList();
    } else {
      console.log('No hay anotaciones de bit√°cora para cargar');
    }

    // Establecer fecha actual por defecto
    const logbookDateInput = document.getElementById('logbook-date');
    if (logbookDateInput) {
      const today = new Date().toISOString().split('T')[0];
      logbookDateInput.value = today;
    }

    // Manejar el bot√≥n de agregar anotaci√≥n
    const addLogbookEntryBtn = document.getElementById('add-logbook-entry');
    if (addLogbookEntryBtn) {
      addLogbookEntryBtn.addEventListener('click', function() {
        const date = document.getElementById('logbook-date').value;
        const title = document.getElementById('logbook-title').value.trim();
        const category = document.getElementById('logbook-category').value;
        const text = document.getElementById('logbook-text').value.trim();
        
        if (!date || !title || !text) {
          showToast('Por favor completa todos los campos obligatorios', 'error');
          return;
        }
        
        if (editingLogbookIndex !== -1) {
          // Modo edici√≥n: actualizar la anotaci√≥n existente en su posici√≥n original
          const entry = logbookEntries[editingLogbookIndex];
          entry.date = date;
          entry.title = title;
          entry.category = category;
          entry.text = text;
          entry.lastModified = new Date().toISOString();
          
          editingLogbookIndex = -1; // Resetear el √≠ndice de edici√≥n
          
          // Restaurar botones a su estado normal
          restoreLogbookButtons();
          
          saveLogbookEntries();
          updateLogbookList();
          clearLogbookForm();
          showToast('Anotaci√≥n actualizada correctamente');
          return;
        }
        
        // Modo agregar: crear nueva anotaci√≥n
        // Obtener ubicaci√≥n si es posible
        const entry = {
          id: Date.now(),
          date: date,
          title: title,
          category: category,
          text: text,
          timestamp: new Date().toISOString()
        };
        
        logbookEntries.push(entry);
        saveLogbookEntries();
        updateLogbookList();
        clearLogbookForm();
        showToast('Anotaci√≥n agregada exitosamente');
      });
    }

    // Funci√≥n para guardar entradas en localStorage
    function saveLogbookEntries() {
      localStorage.setItem('logbook-entries', JSON.stringify(logbookEntries));
      // Actualizar el resumen cuando se guarden cambios en la bit√°cora
      if (typeof updateSummary === 'function') {
        updateSummary();
      }
    }

    // Funci√≥n para limpiar el formulario de bit√°cora
    function clearLogbookForm() {
      document.getElementById('logbook-title').value = '';
      document.getElementById('logbook-text').value = '';
      document.getElementById('logbook-category').selectedIndex = 0;
      // Mantener la fecha actual
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('logbook-date').value = today;
    }

    // Funci√≥n para restaurar botones a su estado normal
    function restoreLogbookButtons() {
      const addButton = document.getElementById('add-logbook-entry');
      const cancelButton = document.getElementById('cancel-edit-logbook');
      
      if (addButton) {
        addButton.innerHTML = '<span class="material-icons">add</span> Agregar Anotaci√≥n';
        addButton.style.backgroundColor = ''; // Restaurar color original
      }
      
      if (cancelButton) {
        cancelButton.style.display = 'none'; // Ocultar bot√≥n cancelar
      }
    }

    // Funci√≥n para cancelar la edici√≥n de bit√°cora
    function cancelLogbookEdit() {
      editingLogbookIndex = -1;
      clearLogbookForm();
      restoreLogbookButtons();
      showToast('Edici√≥n de anotaci√≥n cancelada');
    }

    // Asignar evento al bot√≥n cancelar bit√°cora
    const cancelEditLogbookButton = document.getElementById('cancel-edit-logbook');
    if (cancelEditLogbookButton) {
      cancelEditLogbookButton.addEventListener('click', cancelLogbookEdit);
    }

    // Funci√≥n para actualizar la lista de anotaciones
    function updateLogbookList() {
      const logbookList = document.getElementById('logbook-entries-list');
      if (!logbookList) return;
      
      logbookList.innerHTML = '';
      
      if (logbookEntries.length === 0) {
        logbookList.innerHTML = '<p style="text-align:center; color:var(--text-secondary); padding:16px;">No hay anotaciones en la bit√°cora</p>';
        return;
      }
      
      // Ordenar por fecha m√°s reciente primero
      const sortedEntries = [...logbookEntries].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      sortedEntries.forEach(entry => {
        const li = document.createElement('li');
        li.className = 'list-item logbook-entry-item';
        li.style.marginBottom = '16px';
        li.style.padding = '18px';
        li.style.backgroundColor = '#f8f9fa';
        li.style.borderRadius = '12px';
        li.style.borderLeft = '4px solid var(--primary-color)';
        li.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
        
        const categoryNames = {
          'materiales': 'Materiales/Ingredientes',
          'equipo': 'Equipo de trabajo',
          'proceso': 'Proceso de preparaci√≥n',
          'cliente': 'Cliente/Requisitos',
          'otro': 'Otro'
        };
        
        li.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
            <div style="flex: 1; min-width: 0; margin-right: 12px;">
              <h4 style="margin: 0 0 8px 0; color: var(--primary-color); font-size: 17px; font-weight: 600; word-wrap: break-word; line-height: 1.3;">${entry.title}</h4>
              <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: #666; margin-bottom: 8px;">
                <span style="display: flex; align-items: center; gap: 4px;">
                  <span class="material-icons" style="font-size: 14px;">calendar_today</span>
                  <strong>Fecha:</strong> ${new Date(entry.date).toLocaleDateString('es-PE')}
                </span>
                <span style="display: flex; align-items: center; gap: 4px;">
                  <span class="material-icons" style="font-size: 14px;">category</span>
                  <strong>Categor√≠a:</strong> ${categoryNames[entry.category] || entry.category}
                </span>
                ${entry.lastModified ? '<span style="color: #FF9800; font-weight: bold; display: flex; align-items: center; gap: 4px;"><span class="material-icons" style="font-size: 14px;">edit</span>Editado</span>' : ''}
              </div>
            </div>
            <div class="logbook-action-buttons" style="display: flex; gap: 8px; flex-shrink: 0;">
              <button onclick="editLogbookEntry(${entry.id})" 
                      style="background: #FF9800; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px; min-width: 70px; justify-content: center;"
                      onmouseover="this.style.backgroundColor='#F57C00'" 
                      onmouseout="this.style.backgroundColor='#FF9800'"
                      title="Editar anotaci√≥n">
                <span class="material-icons" style="font-size: 16px;">edit</span>
                <span style="font-size: 10px; font-weight: 600;">EDITAR</span>
              </button>
              <button onclick="deleteLogbookEntry(${entry.id})" 
                      style="background: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px; min-width: 70px; justify-content: center;"
                      onmouseover="this.style.backgroundColor='#D32F2F'" 
                      onmouseout="this.style.backgroundColor='#f44336'"
                      title="Eliminar anotaci√≥n">
                <span class="material-icons" style="font-size: 16px;">delete</span>
                <span style="font-size: 10px; font-weight: 600;">ELIMINAR</span>
              </button>
            </div>
          </div>
          <p style="margin: 0 0 12px 0; line-height: 1.6; color: #333; word-wrap: break-word; background-color: #fff; padding: 12px; border-radius: 8px; border-left: 3px solid #e0e0e0;">${entry.text}</p>
        `;
        
        logbookList.appendChild(li);
      });
    }

    // Funci√≥n global para eliminar entrada de bit√°cora
    window.deleteLogbookEntry = function(id) {
      if (confirm('¬øEst√°s seguro de que quieres eliminar esta anotaci√≥n?')) {
        logbookEntries = logbookEntries.filter(entry => entry.id !== id);
        saveLogbookEntries();
        updateLogbookList();
        showToast('Anotaci√≥n eliminada');
      }
    };

    // Funci√≥n global para editar entrada de bit√°cora
    window.editLogbookEntry = function(id) {
      // Buscar la entrada y su √≠ndice en el array original (sin ordenar)
      const entryIndex = logbookEntries.findIndex(entry => entry.id === id);
      const entry = logbookEntries[entryIndex];
      
      if (entry && entryIndex !== -1) {
        // Guardar la posici√≥n de la anotaci√≥n que se est√° editando
        editingLogbookIndex = entryIndex;
        
        // Llenar el formulario con los datos de la anotaci√≥n
        document.getElementById('logbook-date').value = entry.date;
        document.getElementById('logbook-title').value = entry.title;
        document.getElementById('logbook-category').value = entry.category;
        document.getElementById('logbook-text').value = entry.text;
        
        // Cambiar el bot√≥n para indicar que se est√° editando
        const addButton = document.getElementById('add-logbook-entry');
        const cancelButton = document.getElementById('cancel-edit-logbook');
        
        if (addButton) {
          addButton.innerHTML = '<span class="material-icons">edit</span> Actualizar Anotaci√≥n';
          addButton.style.backgroundColor = '#FF9800'; // Color naranja para edici√≥n
        }
        
        if (cancelButton) {
          cancelButton.style.display = 'block'; // Mostrar bot√≥n cancelar
        }
        
        // Scroll al formulario
        document.getElementById('logbook-date').scrollIntoView({behavior: 'smooth'});
        document.getElementById('logbook-title').focus();
        
        showToast('Editando anotaci√≥n: ' + entry.title, 'warning');
      }
    };
    
    // --- PUNTO DE EQUILIBRIO ---
    
    // Event listeners para actualizar an√°lisis en tiempo real
    const precioVentaInput = document.getElementById('precio-venta');
    const cantidadProducidaInput = document.getElementById('cantidad-producida');
    const costoUnitarioExtraInput = document.getElementById('costo-unitario-extra');
    const rendimientoIngredientesInput = document.getElementById('rendimiento-ingredientes');
    const costosFijosInput = document.getElementById('costos-fijos');
    
    if (precioVentaInput) {
      precioVentaInput.addEventListener('input', () => {
        updateBreakevenCosts();
      });
    }
    
    if (cantidadProducidaInput) {
      cantidadProducidaInput.addEventListener('input', () => {
        updateBreakevenCosts();
      });
    }
    
    if (costoUnitarioExtraInput) {
      costoUnitarioExtraInput.addEventListener('input', () => {
        updateBreakevenCosts();
      });
    }
    
    if (rendimientoIngredientesInput) {
      rendimientoIngredientesInput.addEventListener('input', () => {
        updateBreakevenCosts();
      });
    }
    
    if (costosFijosInput) {
      costosFijosInput.addEventListener('input', () => {
        updateBreakevenCosts();
      });
    }

    // --- PUNTO DE EQUILIBRIO ---
    
    // Bot√≥n para calcular punto de equilibrio
    const calcularBtn = document.getElementById('calcular-equilibrio');
    if (calcularBtn) {
      calcularBtn.addEventListener('click', () => {
        const costosFijos = parseFloat(document.getElementById('costos-fijos').value) || 0;
        const costoUnitarioExtra = parseFloat(document.getElementById('costo-unitario-extra').value) || 0;
        const precioVenta = parseFloat(document.getElementById('precio-venta').value) || 0;
        const cantidadProducida = parseFloat(document.getElementById('cantidad-producida').value) || 0;
        
        // Validaciones b√°sicas
        if (precioVenta <= 0) {
          showToast('El precio de venta debe ser mayor a 0', 'error');
          return;
        }
        
        if (cantidadProducida <= 0) {
          showToast('Debes especificar cu√°ntas unidades rinden los ingredientes', 'error');
          return;
        }
        
        // Calcular costo variable unitario (ingredientes + extra)
        let ingredientes = JSON.parse(localStorage.getItem('ingredients') || '[]');
        let costoTotalIngredientes = ingredientes.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        
        // Validar que tengamos ingredientes
        if (costoTotalIngredientes <= 0) {
          showToast('Primero debes agregar ingredientes con precios en la pesta√±a correspondiente', 'error');
          return;
        }
        
        // El costo variable unitario usa la cantidad que realmente rinden los ingredientes
        let costoVariableUnitario = costoTotalIngredientes / cantidadProducida;
        costoVariableUnitario += costoUnitarioExtra;
        
        // Determinar si estamos en p√©rdida o ganancia
        let enPerdida = precioVenta <= costoVariableUnitario;
        let unidadesEquilibrio, ingresosEquilibrio;
        
        if (enPerdida) {
          // En p√©rdida: mostrar mensaje educativo y simular punto de equilibrio te√≥rico
          let deficit = costoVariableUnitario - precioVenta;
          showToast(
            `‚ö†Ô∏è ALERTA: Est√°s en P√âRDIDA de S/${deficit.toFixed(2)} por unidad. ` +
            `Cada producto que vendas te har√° perder dinero. ` +
            `Debes subir el precio a m√≠nimo S/${(costoVariableUnitario + 0.01).toFixed(2)} para no perder.`,
            'error'
          );
          
          // Calcular un punto de equilibrio te√≥rico para mostrar en el gr√°fico
          unidadesEquilibrio = 0; // No hay punto de equilibrio real
          ingresosEquilibrio = 0;
        } else {
          // Calcular punto de equilibrio normal
          unidadesEquilibrio = costosFijos / (precioVenta - costoVariableUnitario);
          unidadesEquilibrio = Math.max(0, Math.ceil(unidadesEquilibrio));
          ingresosEquilibrio = unidadesEquilibrio * precioVenta;
          
          showToast('Punto de equilibrio calculado correctamente - ¬°Tienes un negocio viable!', 'success');
        }
        
        // Mostrar en la UI seg√∫n el escenario
        if (enPerdida) {
          document.getElementById('punto-equilibrio-unidades').textContent = 'No alcanzable';
          document.getElementById('punto-equilibrio-unidades').style.color = '#f44336';
          document.getElementById('punto-equilibrio-ingresos').textContent = 'S/0.00 (P√âRDIDA)';
          document.getElementById('punto-equilibrio-ingresos').style.color = '#f44336';
        } else {
          document.getElementById('punto-equilibrio-unidades').textContent = unidadesEquilibrio.toLocaleString();
          document.getElementById('punto-equilibrio-unidades').style.color = '#4caf50';
          document.getElementById('punto-equilibrio-ingresos').textContent = 'S/' + ingresosEquilibrio.toFixed(2);
          document.getElementById('punto-equilibrio-ingresos').style.color = '#4caf50';
        }
        
        // Guardar en localStorage
        localStorage.setItem('puntoEquilibrioUnidades', unidadesEquilibrio);
        localStorage.setItem('puntoEquilibrioIngresos', ingresosEquilibrio.toFixed(2));
        localStorage.setItem('costoVariableUnitario', costoVariableUnitario.toFixed(2));
        localStorage.setItem('costosFijos', costosFijos.toFixed(2));
        localStorage.setItem('precioVenta', precioVenta.toFixed(2));
        
        // Mostrar mensaje educativo din√°mico
        mostrarMensajeEducativo(enPerdida, costoVariableUnitario, precioVenta, unidadesEquilibrio, costosFijos);
        
        // Generar gr√°fico SVG simple SIEMPRE (incluso en p√©rdidas)
        if (window.generarGraficoPuntoEquilibrio) {
          try {
            console.log('Generando gr√°fico SVG con datos:', {
              costosFijos, costoVariableUnitario, precioVenta, unidadesEquilibrio, enPerdida
            });
            const ok = window.generarGraficoPuntoEquilibrio(
              costosFijos, 
              costoVariableUnitario, 
              precioVenta, 
              unidadesEquilibrio,
              enPerdida // Nuevo par√°metro para indicar si hay p√©rdida
            );
            if (ok) {
              console.log('Gr√°fico SVG generado exitosamente');
            }
          } catch (error) {
            console.error('Error al generar gr√°fico SVG:', error);
          }
        }
      });
    }

    // Funci√≥n para mostrar mensajes educativos din√°micos
    function mostrarMensajeEducativo(enPerdida, costoVariableUnitario, precioVenta, unidadesEquilibrio, costosFijos) {
      const mensajeContainer = document.getElementById('mensaje-educativo');
      const contenidoMensaje = document.getElementById('contenido-mensaje');
      
      if (!mensajeContainer || !contenidoMensaje) return;
      
      let mensaje = '';
      let estilo = '';
      
      if (enPerdida) {
        const perdidaPorUnidad = costoVariableUnitario - precioVenta;
        const precioMinimo = costoVariableUnitario + 0.01;
        const gananciaMinimaRecomendada = costoVariableUnitario * 0.3; // 30% margen
        const precioRecomendado = costoVariableUnitario + gananciaMinimaRecomendada;
        
        estilo = 'background: linear-gradient(135deg, #ffebee, #fce4ec); border: 2px solid #f44336; box-shadow: 0 4px 8px rgba(244, 67, 54, 0.2);';
        
        mensaje = `
          <div style="text-align: center; margin-bottom: 16px;">
            <h3 style="color: #d32f2f; margin: 0; font-size: 20px;">‚ö†Ô∏è ¬°ALERTA DE P√âRDIDA!</h3>
            <p style="color: #c62828; font-size: 16px; margin: 8px 0 0 0; font-weight: 600;">
              Cada producto vendido te hace perder S/${perdidaPorUnidad.toFixed(2)}
            </p>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px; border-left: 4px solid #f44336;">
              <h4 style="margin: 0 0 8px 0; color: #d32f2f;">üìä Tu Situaci√≥n Actual</h4>
              <p style="margin: 0; line-height: 1.5;">
                <strong>Costo por unidad:</strong> S/${costoVariableUnitario.toFixed(2)}<br>
                <strong>Precio de venta:</strong> S/${precioVenta.toFixed(2)}<br>
                <strong>P√©rdida:</strong> S/${perdidaPorUnidad.toFixed(2)} por producto
              </p>
            </div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00;">üí° Soluciones Inmediatas</h4>
              <p style="margin: 0; line-height: 1.5;">
                <strong>Precio m√≠nimo:</strong> S/${precioMinimo.toFixed(2)}<br>
                <strong>Precio recomendado:</strong> S/${precioRecomendado.toFixed(2)}<br>
                <strong>Ganancia esperada:</strong> 30% sobre costos
              </p>
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.9); padding: 16px; border-radius: 8px; border: 1px solid #ff9800;">
            <h4 style="margin: 0 0 12px 0; color: #e65100;">üéØ Ejercicio de Reflexi√≥n</h4>
            <p style="margin: 0; color: #bf360c; line-height: 1.6;">
              <strong>Pregunta clave:</strong> Si vendieras 100 unidades a tu precio actual, perder√≠as S/${(perdidaPorUnidad * 100).toFixed(2)}. 
              ¬øQu√© estrategias puedes usar para reducir costos o aumentar el valor percibido de tu producto?
            </p>
          </div>
        `;
      } else {
        const margen = precioVenta - costoVariableUnitario;
        const porcentajeMargen = ((margen / costoVariableUnitario) * 100);
        const gananciaAnual = (unidadesEquilibrio * margen * 12); // Estimaci√≥n anual
        
        estilo = 'background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border: 2px solid #4caf50; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2);';
        
        mensaje = `
          <div style="text-align: center; margin-bottom: 16px;">
            <h3 style="color: #2e7d32; margin: 0; font-size: 20px;">‚úÖ ¬°NEGOCIO VIABLE!</h3>
            <p style="color: #388e3c; font-size: 16px; margin: 8px 0 0 0; font-weight: 600;">
              Punto de equilibrio alcanzable en ${unidadesEquilibrio} unidades
            </p>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h4 style="margin: 0 0 8px 0; color: #2e7d32;">üìà An√°lisis de Rentabilidad</h4>
              <p style="margin: 0; line-height: 1.5;">
                <strong>Margen por unidad:</strong> S/${margen.toFixed(2)}<br>
                <strong>Margen porcentual:</strong> ${porcentajeMargen.toFixed(1)}%<br>
                <strong>Estado:</strong> ${porcentajeMargen >= 30 ? 'üü¢ Excelente' : porcentajeMargen >= 20 ? 'üü° Bueno' : 'üü† Mejorable'}
              </p>
            </div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h4 style="margin: 0 0 8px 0; color: #1976d2;">üéØ Proyecci√≥n</h4>
              <p style="margin: 0; line-height: 1.5;">
                <strong>Unidades para equilibrio:</strong> ${unidadesEquilibrio}<br>
                <strong>A partir de unidad:</strong> ${unidadesEquilibrio + 1}<br>
                <strong>Comenzar√°s a ganar dinero</strong> üí∞
              </p>
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.9); padding: 16px; border-radius: 8px; border: 1px solid #2196f3;">
            <h4 style="margin: 0 0 12px 0; color: #1565c0;">üí° Consejo Educativo</h4>
            <p style="margin: 0; color: #0d47a1; line-height: 1.6;">
              <strong>Estrategia de crecimiento:</strong> Una vez que superes las ${unidadesEquilibrio} unidades, cada venta adicional 
              te dar√° S/${margen.toFixed(2)} de ganancia pura. ¬øC√≥mo puedes aumentar tus ventas para maximizar beneficios?
            </p>
          </div>
        `;
      }
      
      contenidoMensaje.innerHTML = mensaje;
      mensajeContainer.style.cssText = estilo;
      mensajeContainer.style.display = 'block';
      
      // Animaci√≥n de entrada
      mensajeContainer.style.opacity = '0';
      mensajeContainer.style.transform = 'translateY(20px)';
      mensajeContainer.style.transition = 'all 0.5s ease';
      
      setTimeout(() => {
        mensajeContainer.style.opacity = '1';
        mensajeContainer.style.transform = 'translateY(0)';
      }, 100);
    }

    // Cargar valores guardados del punto de equilibrio al iniciar
    function loadBreakevenData() {
      const costosFijos = localStorage.getItem('costosFijos');
      const costoUnitarioExtra = localStorage.getItem('costoUnitarioExtra');
      const precioVenta = localStorage.getItem('precioVenta');
      const cantidadProducida = localStorage.getItem('cantidadProducida');
      const puntoEquilibrioUnidades = localStorage.getItem('puntoEquilibrioUnidades');
      const puntoEquilibrioIngresos = localStorage.getItem('puntoEquilibrioIngresos');
      
      if (costosFijos) document.getElementById('costos-fijos').value = costosFijos;
      if (costoUnitarioExtra) document.getElementById('costo-unitario-extra').value = costoUnitarioExtra;
      if (precioVenta) document.getElementById('precio-venta').value = precioVenta;
      if (cantidadProducida) document.getElementById('cantidad-producida').value = cantidadProducida;
      if (puntoEquilibrioUnidades) document.getElementById('punto-equilibrio-unidades').textContent = puntoEquilibrioUnidades;
      if (puntoEquilibrioIngresos) document.getElementById('punto-equilibrio-ingresos').textContent = 'S/' + puntoEquilibrioIngresos;
    }
    
    // Guardar valores cuando cambian los inputs
    function setupBreakevenInputListeners() {
      const inputs = ['costos-fijos', 'costo-unitario-extra', 'precio-venta', 'cantidad-producida'];
      inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('input', () => {
            localStorage.setItem(inputId.replace('-', ''), input.value);
          });
        }
      });
    }
    
    // Cargar datos y configurar listeners
    loadBreakevenData();
    setupBreakevenInputListeners();
    
    // --- MANEJO DEL LOGO DEL REPORTE ---
    const reportLogoInput = document.getElementById('report-logo');
    const logoPreview = document.getElementById('logo-preview');
    const logoImage = document.getElementById('logo-image');
    const removeLogo = document.getElementById('remove-logo');
    
    // Cargar logo guardado
    const savedLogo = localStorage.getItem('report-logo');
    if (savedLogo) {
      logoImage.src = savedLogo;
      logoPreview.style.display = 'flex';
    }
    
    // Manejar carga de nuevo logo
    if (reportLogoInput) {
      reportLogoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const logoData = e.target.result;
            localStorage.setItem('report-logo', logoData);
            logoImage.src = logoData;
            logoPreview.style.display = 'flex';
            showToast('Logo cargado correctamente');
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Remover logo
    if (removeLogo) {
      removeLogo.addEventListener('click', function() {
        localStorage.removeItem('report-logo');
        logoImage.src = '';
        logoPreview.style.display = 'none';
        reportLogoInput.value = '';
        showToast('Logo removido');
      });
    }
    
    // --- FUNCI√ìN BORRAR TODO ---
    const resetAllButton = document.getElementById('reset-all-header');
    console.log('Bot√≥n reset encontrado:', resetAllButton);
    
    if (resetAllButton) {
      resetAllButton.addEventListener('click', function() {
        console.log('üóëÔ∏è Bot√≥n Borrar Todo clickeado');
        
        // Mostrar confirmaci√≥n antes de borrar
        const confirmDelete = confirm(
          '‚ö†Ô∏è ADVERTENCIA: Esto borrar√° TODA la informaci√≥n de la aplicaci√≥n\n\n' +
          '‚Ä¢ Ingredientes\n' +
          '‚Ä¢ Pasos de preparaci√≥n\n' +
          '‚Ä¢ Todas las fotos\n' +
          '‚Ä¢ Bit√°cora completa\n' +
          '‚Ä¢ An√°lisis de costos\n' +
          '‚Ä¢ Logo del reporte\n' +
          '‚Ä¢ Configuraciones\n\n' +
          '¬øEst√°s seguro de que quieres continuar?'
        );
        
        console.log('Primera confirmaci√≥n:', confirmDelete);
        
        if (confirmDelete) {
          // Segunda confirmaci√≥n para estar seguro
          const finalConfirm = confirm(
            'üö® √öLTIMA CONFIRMACI√ìN\n\n' +
            'Esta acci√≥n NO se puede deshacer.\n' +
            'Se perder√°n TODOS los datos.\n\n' +
            '¬øProceder con el borrado completo?'
          );
          
          console.log('Segunda confirmaci√≥n:', finalConfirm);
          
          if (finalConfirm) {
            console.log('Ejecutando borrarTodoCompletamente...');
            borrarTodoCompletamente();
          }
        }
      });
      console.log('‚úÖ Event listener agregado al bot√≥n reset');
    } else {
      console.error('‚ùå Bot√≥n reset-all-header no encontrado en el DOM');
    }
    
    // Funci√≥n para borrar todo completamente
    function borrarTodoCompletamente() {
      console.log('üóëÔ∏è INICIANDO borrarTodoCompletamente()');
      
      try {
        console.log('üóëÔ∏è Iniciando borrado completo de datos...');
        
        // 1. Limpiar localStorage completamente
        const keysToRemove = [
          'recipe-title', 'chef-name', 'ingredients', 'steps',
          'before-photos-photos', 'during-photos-photos', 'after-photos-photos',
          'logbook-entries', 'costosFijos', 'costoUnitarioExtra', 'precioVenta',
          'cantidadProducida', 'puntoEquilibrioUnidades', 'puntoEquilibrioIngresos',
          'costoVariableUnitario', 'rendimientoIngredientes', 'report-logo', 'breakevenChartImage'
        ];
        
        console.log('Removiendo claves de localStorage:', keysToRemove);
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
          console.log(`‚úÖ Removido: ${key}`);
        });
        
        // 2. Limpiar DOM
        const containers = ['ingredients-list', 'steps-list', 'before-photos', 'during-photos', 'after-photos'];
        console.log('Limpiando contenedores DOM:', containers);
        containers.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = '';
            console.log(`‚úÖ Limpiado contenedor: ${id}`);
          } else {
            console.warn(`‚ö†Ô∏è Contenedor no encontrado: ${id}`);
          }
        });
        
        // 3. Limpiar inputs
        const inputs = ['recipe-title', 'ingredient-name', 'ingredient-quantity', 'ingredient-unit', 'ingredient-price', 'step-text'];
        console.log('Limpiando inputs:', inputs);
        inputs.forEach(id => {
          const input = document.getElementById(id);
          if (input) {
            input.value = '';
            console.log(`‚úÖ Limpiado input: ${id}`);
          } else {
            console.warn(`‚ö†Ô∏è Input no encontrado: ${id}`);
          }
        });
        
        // 4. Limpiar logo
        const logoPreview = document.getElementById('logo-preview');
        if (logoPreview) {
          logoPreview.style.display = 'none';
          console.log('‚úÖ Logo preview ocultado');
        }
        
        // 5. Actualizar res√∫menes
        console.log('Actualizando res√∫menes...');
        if (typeof updateSummary === 'function') {
          updateSummary();
          console.log('‚úÖ updateSummary ejecutado');
        }
        
        if (typeof updateSummaryPhotos === 'function') {
          updateSummaryPhotos();
          console.log('‚úÖ updateSummaryPhotos ejecutado');
        }
        
        // 6. Volver a primera pesta√±a
        const firstTab = document.querySelector('.nav-tab[data-tab="ingredients"]');
        if (firstTab) {
          firstTab.click();
          console.log('‚úÖ Vuelto a primera pesta√±a');
        }
        
        console.log('üéâ Borrado completo exitoso');
        showToast('‚úÖ Todos los datos han sido borrados. Aplicaci√≥n lista para empezar de nuevo', 'success');
        
      } catch (error) {
        console.error('‚ùå Error durante el borrado completo:', error);
        showToast('Error al borrar los datos. Intenta recargar la p√°gina', 'error');
      }
    }
});
</script>
</body>
</html>